
# Robust spatiotemporal model of dissolved oxygen off the coast of Washington state, USA.

## Background

The Northwest Fisheries Science Center (NWFSC) conducts an annual trawl survey off the coast of Washington, Oregon, and California, to sample fish communities and collect data that are used to generate fishery independent indices of abundance for stock assessments. As part of that work, several environmental or physical samples are also collected from each haul. Examples include sea surface and bottom temperature, as well as dissolved oxygen (DO, mL / L). Oxygen may directly affect the probability of species occurence as well as the community composition of groundfish assemblages ([Keller et al. 2015](http://onlinelibrary.wiley.com/doi/10.1111/fog.12100/abstract
)).  
  
The data from the trawl survey - both biotic and environmental variables - are publicly availbale from the NWFSC, [https://www.nwfsc.noaa.gov/data/map](https://www.nwfsc.noaa.gov/data/map).  

## Load packages  
```{r chunkSet, warning=FALSE,message=FALSE,results="hide"}
library(ggplot2)
library(knitr)
library(rstan)
library(reshape2)
library(rrfields)
library(dplyr)
opts_chunk$set(tidy=TRUE, message=FALSE,warning=FALSE)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

## Prepare data  

Dissolved oxygen data have been reliably collected since 2008. We'll restrict the analysis geographically for this example to just include Washington state.  
  
```{r, fig.pos="placeHere", fig.cap = "Dissolved oxygen samples from the NWFSC trawl survey (2009 - 2015). Oxygen samples are quantified as millileters per liter."}
d = read.csv("../../crabs/data/TrawlHaulChars_since2002.csv")
d = d[which(is.na(d$o2_at_gear_ml_per_l_der) == FALSE &
d$date_dim.year > 2008), ]
d = d[, c(
"haul_latitude_dim.latitude_in_degrees",
"haul_longitude_dim.longitude_in_degrees",
"date_dim.year",
"o2_at_gear_ml_per_l_der",
"seafloor_depth_m_der"
)]

d$year = as.numeric(d$date_dim.year)

# Data north of 42 are WA coast
d = d[which(d$haul_latitude_dim.latitude_in_degrees > 42), ]

# rename variables
d = rename(d, dissolved_O2 = o2_at_gear_ml_per_l_der)
d = rename(d, lat_dd = haul_latitude_dim.latitude_in_degrees)
d = rename(d, lon_dd = haul_longitude_dim.longitude_in_degrees)

ggplot(
d,
aes(
lon_dd,
lat_dd,
color = dissolved_O2
)
) + geom_point() + facet_wrap( ~ year) + 
  xlab("Longitude") + ylab("Latitude")
```

## Fit robust model using rrfields

For this example, we'll use ln(depth) as a predictor variable, in addition to the spatial component (which we'll model as an AR(1) process). Dissolved oxygen are positive, so we'll use a gamma distribution for the observation model. 

```{r run_model}
d$logdepth = log(d$seafloor_depth_m_der)

if(!file.exists("../../wc_o2_example.rds")) {
stan_mod = rrfield(dissolved_O2 ~ logdepth, lon="lon_dd",
  lat="lat_dd", nknots = 75, 
  obs_error = "gamma", data=d, time="year", estimate_ar = TRUE, chains=3)
saveRDS(stan_mod,file="wc_o2_example.rds")
}
if(file.exists("../../wc_o2_example.rds")) {
  stan_mod = readRDS("../../wc_o2_example.rds")
}
```

## Parameter estimates  

The estimated degrees of freedom suggests that the t-distribution is apporpriate (median = 7.3, 90% CIs = 3, 18.8). 
```{r, fig.pos="placeHere", fig.cap = "Estimated degrees of freedom from robust spatial model."}
df = extract(stan_mod$model, pars = "df")$df
ggplot(as.data.frame(df), aes(df)) +
geom_density(col = "blue", fill = "blue") + xlab("Estimated df")
```

We can also look at the posteriors for other parameters of interest. In particular, `B[2]` corresponds to the estimated slope of the relationship between ln(depth) and dissolved oxygen.  
```{r, fig.pos="placeHere", fig.cap="Posterior estimates for other model parameters."}
plot(stan_mod$model, pars = c("ar", "B", "gp_scale", "gp_sigma", "CV"))
```

## Stan diagnostics

```{r, fig.pos="placeHere", fig.cap = "Diagnostics of acceptance statistics and log posterior."}
stan_diag(stan_mod$model, info="sample")
#stan_diag(stan_mod$model, info="stepsize")
#stan_diag(stan_mod$model, info="treedepth")
#stan_diag(stan_mod$model, info="divergence")
```

## Predictions  

Because we didn't hold out any data for this example, we can only examine the predicted to observed values. 

```{r}
pred <- predict(stan_mod, interval = "confidence", conf_level = 0.9)
d$pred = pred$estimate
d$conf_low = pred$conf_low
d$conf_high = pred$conf_high
```

```{r, fig.pos="placeHere", fig.cap = "Predicted versus observed dissolved oxygen values, in link space (log)."}
ggplot(d, aes(log(dissolved_O2), pred)) + geom_point(col = "grey30", alpha =
    0.5) + ylab("Predicted") + xlab("Ln(Observed)") + geom_abline(
    intercept = 0,
    slope = 1,
    col = "red",
    linetype = 1
    ) + facet_wrap( ~ year)
```

```{r, fig.pos="placeHere", fig.cap = "Predicted dissolved oxygen values versus residuals, in link space (log)."}
ggplot(d, aes(pred, log(dissolved_O2) - pred)) + geom_point(col = "grey30", alpha =
    0.5) + xlab("Predicted") + ylab("Residual") + geom_abline(
    intercept = 0,
    slope = 0,
    col = "red",
    linetype = 1
    ) + facet_wrap( ~ year)
```

We can look at residuals in space to see any evidence of clustering,  
```{r}
d$residual = log(d$dissolved_O2) - d$pred
ggplot(d, aes(lon_dd, lat_dd)) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  scale_colour_gradient2() + 
  geom_point(aes(colour = residual)) + 
  facet_wrap( ~ year) +
  ggtitle("Spatial residuals")
```


We can also look at the intervals in normal (repsonse) space. The confidence intervals generated above are intervals around the predicted mean; the prediction intervals include new data. 

```{r}
pred <- predict(stan_mod, interval = "prediction", type="response", conf_level = 0.9)
d$pred = pred$estimate
d$conf_low = pred$conf_low
d$conf_high = pred$conf_high
```

```{r, fig.pos="placeHere", fig.cap = "Predicted versus observed dissolved oxygen values, in link space (log)."}
ggplot(d, aes(dissolved_O2, pred)) + geom_point(col = "grey30", alpha =
    0.5) + ylab("Predicted") + xlab("Ln(Observed)") + geom_abline(
    intercept = 0,
    slope = 1,
    col = "red",
    linetype = 1
    ) + facet_wrap(~ year) + 
  geom_errorbar(aes(ymin = conf_low, ymax = conf_high), alpha = 0.3)
```
