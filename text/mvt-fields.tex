\documentclass[12pt,english]{article}
\usepackage{geometry}
\geometry{verbose, letterpaper, tmargin = 2.54cm, bmargin = 2.54cm,
  lmargin = 2.54cm, rmargin = 2.54cm}
\geometry{letterpaper}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{setspace}
\usepackage{url}
\usepackage{lineno}
\usepackage{xcolor}
\usepackage{bm}
\renewcommand\linenumberfont{\normalfont\tiny\sffamily\color{gray}}
\modulolinenumbers[2]
\usepackage{booktabs}
\usepackage{bm}
\textheight 22.0cm
% \usepackage{mathptmx}
\usepackage{nameref}

% Linux Libertine:
% \usepackage{textcomp}
% \usepackage[sb]{libertine}
% \usepackage[varqu,varl]{inconsolata}% sans serif typewriter
% \usepackage[libertine,bigdelims,vvarbb]{newtxmath} % bb from STIX
% \usepackage[cal=boondoxo]{mathalfa} % mathcal
% \useosf % osf for text, not math
% \usepackage[supstfm=libertinesups,%
%   supscaled=1.2,%
%   raised=-.13em]{superiors}

% Fix line numbering and align environment
% http://phaseportrait.blogspot.ca/2007/08/lineno-and-amsmath-compatibility.html
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
  \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
  \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
  \renewenvironment{#1}%
     {\linenomath\csname old#1\endcsname}%
     {\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
  \patchAmsMathEnvironmentForLineno{#1}%
  \patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
\patchBothAmsMathEnvironmentsForLineno{equation}%
\patchBothAmsMathEnvironmentsForLineno{align}%
\patchBothAmsMathEnvironmentsForLineno{flalign}%
\patchBothAmsMathEnvironmentsForLineno{alignat}%
\patchBothAmsMathEnvironmentsForLineno{gather}%
\patchBothAmsMathEnvironmentsForLineno{multline}%
}

% remove numbers in front of sections:
% \makeatletter
% \renewcommand\@seccntformat[1]{}
% \makeatother

\newcommand{\R}[1]{\label{#1}\linelabel{#1}}
\newcommand{\lr}[1]{line~\lineref{#1}}

\hyphenation{glmmfields}

% \usepackage{pdflscape}
\usepackage{lscape}
\usepackage{makecell}
\usepackage{array}
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
% \usepackage{parskip}
% \setlength{\parindent}{0pt}
% \setlength{\parskip}{1\bigskipamount plus \smallskipamount minus \smallskipamount}
\usepackage{ragged2e}
\setlength{\RaggedRightParindent}{\parindent}
\usepackage[round,sectionbib]{natbib}
\bibpunct{(}{)}{,}{a}{}{,}
\bibliographystyle{ecology}

\usepackage{titlesec}
\titlespacing*{\section}
{0pt}{1.5ex plus 1ex minus .2ex}{1.0ex plus .2ex}
\titlespacing*{\subsection}
{0pt}{1.5ex plus 1ex minus .2ex}{1.0ex plus .2ex}

% \setlength{\abovedisplayskip}{-30pt}
% \setlength{\belowdisplayskip}{-30pt}
% \setlength{\abovedisplayshortskip}{-30pt}
% \setlength{\belowdisplayshortskip}{-30pt}

\title{
  \vspace{-1.4cm}
  Black swans in space:
  % robust
  modelling
  % of
  spatiotemporal processes with extremes}
\author{
Sean C. Anderson$^{1\ast}$ and
Eric J. Ward$^2$
}
\date{}

\begin{document}

\maketitle

$^1$School of Aquatic and Fishery Sciences, Box 355020, University of
Washington, Seattle, WA 98195, USA

$^2$Conservation Biology Division, Northwest Fisheries Science Center, National
Marine Fisheries Service, National Oceanographic and Atmospheric Administration,
2725 Montlake Blvd E, Seattle, WA 98112, USA

$^{\ast}$Corresponding author. Present address:
Aquatic Resources, Research and Assessment Division,
Fisheries and Oceans Canada,
Pacific Biological Station,
3190 Hammond Bay Road,
Nanaimo, BC, V6T 6N7, Canada

\RaggedRight
\hyphenpenalty=500

% \begin{spacing}{1.4}
\begin{spacing}{1.9}
% \begin{flushleft}
\linenumbers

\input{sim-values}


\begin{abstract}

% Projected trends in climate forcing
% suggest a need to increasingly focus on
% variability and extremes in ecological processes.
In ecological systems, extremes can happen
in time, such as population crashes,
or in space, such as rapid range contractions.
However, current methods for
joint inference about temporal and spatial dynamics
(e.g.\ spatiotemporal modelling with Gaussian random fields)
may perform poorly when
underlying processes include extreme events.
Here we introduce a model that allows for extremes
to occur simultaneously in time and space.
Our model is a Bayesian predictive-process GLMM
(generalized linear mixed-effects model)
that uses a multivariate-t distribution to describe spatial random effects.
The approach is easily implemented with
our flexible R package \textbf{glmmfields}.
First, using simulated data,
we demonstrate the ability to recapture spatiotemporal extremes,
and explore the consequences of fitting models that ignore such extremes.
Second, we predict
tree mortality from mountain pine beetle (\emph{Dendroctonus ponderosae})
outbreaks in the US Pacific Northwest over the last 16 years.
We show that our approach provides
more accurate and precise predictions
compared to traditional spatiotemporal models
when extremes are present.
Our R package makes these models
accessible to a wide range of ecologists
and scientists in other disciplines interested in
fitting spatiotemporal GLMMs, with and without extremes.
\end{abstract}

% glmmrf
% glmrf
% glmmfields
% glmfields
%
% rrfields
% rtfields
% mvtfields
%
% cygnus

\section{Introduction}

Applications of statistical models that allow for joint inference about spatial
and temporal dynamics have advanced rapidly in ecology over the last several
decades \citep[e.g.][]{bascompte1995, latimer2009, conn2015}. Spatiotemporal
models have also been widely used in other disciplines, including applications
to weather, remote sensing, human disease dynamics, and crime
\citep{cressie2011}. When ecological data are spatially structured, explicitly
accounting for spatial autocorrelation can improve model predictions and
inference about parameters of interest \citep[e.g.][]{thorson2015}.

Including spatial components in statistical models involves extending models
that most ecologists are already familiar with, such as generalized linear
models (GLMs) or generalized additive models (GAMs). Spatial relationships can
be included as predictors in models of the mean (such as in a 2-dimensional GAM)
or can be included in models of the covariance (e.g.\ kriging). Recent
extensions of these spatial covariance models include modelling spatial
deviations in GLMs or GAMs as random effects (Gaussian random fields, GRFs).
Examples of these methods in existing R packages include but are not limited to
\textbf{spBayes} \citep{finley2007}, \textbf{INLA} \citep{rue2009}, and
\textbf{spate} \citep{sigrist2015} (see~Table~\ref{tab:packages}).

A limitation of spatial models that use GRFs is that they may perform poorly
when data include extreme events. When models describing the spatial process
also include an observation model, for example, anomalous observations may be
reconciled by increasing the variance of the observation error (rather than
attributing these to extremes in the process). Extremes in temporal processes
have been modelled using a variety of methods in ecology, typically by including
mixtures of normal and heavy-tailed distributions \citep[e.g.][]{everitt1996,
  ward2007, thorson2011}. More recently, the Student-$t$ distribution has been
proposed as a solution to modelling process variation with extremes in
population dynamics \citep{anderson2017}.

Several extensions of GRFs have been proposed to better capture extreme spatial
events, including max-stable or extreme value theory \citep{davison2012,
  davison2012a}, where quantities of interest include probabilities of exceeding
some threshold \citep{davis2008}. Other extensions of spatiotemporal models to
describing extremes include the use of multivariate-$t$ (MVT) spatial random
fields \citep{roislien2007}. Focusing on the latter, to our knowledge these
methods have not been applied in ecology, fisheries, or environmental sciences.

In this paper we introduce the use of robust spatial predictive models using the
MVT distribution, and provide a user-friendly implementation in our new R
package \textbf{glmmfields}. Using simulation testing, we illustrate that the
MVT model leads to better prediction (greater accuracy, more precision) when the
spatial process includes heavy-tails. As an application to real-world data, we
apply this model to data on mountain pine beetle (\textit{Dendroctonus
  ponderosae}) outbreaks in the Pacific Northwest of the United States.

\section{Methods}

We seek to allow for large deviations in an ecological spatial pattern over time
by extending spatiotemporal predictive process models to use a MVT distribution
instead of a MVN distribution. Below we describe the form of the model as
implemented in \textbf{glmmfields}, describe two simulation tests exploring
model performance, and finally describe the application of our model to a data
set of mountain pine beetle outbreaks.

\subsection{Predictive process models}

\citet{latimer2009} provide an overview of predictive process models for
ecologists. For large datasets, estimating spatial random effects at many
locations may be computationally prohibitive. One solution is to estimate a
spatial field as correlated random effects at a subset of locations or $m$
`knots' \citep[e.g.][]{latimer2009, shelton2014}, where $m < n$, the number of
data points. The location of the $m$ knots describing a random field can be
chosen via a clustering algorithm, such as the partitioning around medoids
algorithm \citep{reynolds2006}.
% \citep[e.g.\ the \texttt{pam} function in the R package
% \textbf{cluster};][]{reynolds2006}.
Instead of estimating an unconstrained $m \times m$ covariance matrix, a
covariance function is specified \emph{a priori} to model covariance as a
function of distance. Our \textbf{glmmfields} package allows for the isotropic
squared exponential (Gaussian), exponential, and Matern covariance functions;
however, anisotropic functions could be included. Given estimated random effects
at the knot locations, the known distance matrix between the knots and observed
data, the knot random effects can be projected to the locations of the
observations \citep[][Fig.~\ref{fig:didactic}]{roislien2007, latimer2009,
  finley2009}.

As an example, the squared exponential covariance function models the
correlation between points $i$ and $j$ as $H(\delta_{ij}) = \exp
\left(-\frac{\delta_{ij}^2}{2 \eta} \right)$, where $\delta_{ij}$ is the
distance between points $i$ and $j$ and $\eta$ controls how steeply correlation
declines with distance. For a given set of $\delta_{ij}$, large values of $\eta$
correspond to smooth spatial patterns and small values correspondence to wiggly
spatial patterns.
% --- the degree of wiggliness implied by a value of $\eta$
% depends on the scale of the $\delta_{ij}$.
The elements of the covariance matrix $\Sigma$ at the $m$ knot locations are
then defined as $\Sigma_{ij}^*=\sigma^2 \left( \frac{-\delta_{ij}^2}{2 \eta}
\right)$ with the parameter $\sigma$ scaling the amplitude of the spatial
deviations. Following \citet{latimer2009}, we can calculate the covariance
matrix between the data locations and the knots, $\Sigma_{\left(W, W^*
  \right)}$. Given $\Sigma^*$, we can generate random effects at knot locations
$W_t^*$ by drawing from a multivariate distribution (MVN or MVT) with covariance
$\Sigma^*$ and project these to the data locations using $\Sigma_{\left( W,W^{*}
  \right)}$: $W=\Sigma_{\left(W,W^* \right)}^{'} \Sigma^{*-1}W^*$.

% Here, we summarize the important features of these models and highlight how
% our new MVT model differs from the MVN version.

\subsection{MVT random fields}

Our model is essentially a GLMM with a spatiotemporal element described by a MVN
or MVT random field. The mean, $\mu \equiv \mathbb{E}(y)$, at a set of locations
in space $s$ and time $t$ is $g(\mu_{s,t}) = \bm{X}_{s,t} \bm{\beta} +
\gamma_{s,t},$ where $g$ is a link function, $\bm{X}_{s,t}$ represents the
predictors, and $\bm{\beta}$ represents estimated coefficients. The symbol
$\gamma$ represents the spatiotemporal process, described below. The variance of
the observation component of our model is a function of the mean via a
probability distribution such as the Gaussian, Poisson, or gamma.

Modifying the MVN spatiotemporal model to the more flexible MVT distribution
requires estimating the degrees of freedom parameter $\nu$. When $\nu$ is small
(say $\nu < 10$) the distribution has heavier tails than the MVN
--- meaning, extreme events are more likely (Fig.~\ref{fig:nu}). For most
purposes, the MVT and MVN are indistinguishable for moderate values of $\nu$
(say $\nu > 20$) similarly to the univariate $t$-distribution compared with the
normal distribution \citep[e.g.][]{anderson2017}. If $W_{s,t}$
defines a random field, then the spatiotemporal element, $\gamma_{s,t}$, can be
made temporally constant (one field shared across time, $\gamma_{s,t} = W_{s}$),
independent at each time step ($\gamma_{s,t} = W_{s,t}$), or autoregressive so
that the spatial pattern at time $t$ is dependent on the spatial pattern at time
$t-1$ to a degree defined by $\phi$, ($\gamma_{s,t} = \phi \gamma_{s,t-1} +
W_{s,t}$).
% In the last case, we constrain the spatiotemporal autoregressive process to be
% centred on zero at each time step to aid interpretation and ensure
% identifiability ($\gamma_{s,t} = \phi (\gamma_{s,t-1} -
% \mathbb{E}[\gamma_{t-1}]) + W_{s,t}$). This lets the mean process be defined
% by the linear predictor ($\bm{X_{s,t}}\bm{\beta}$) while $\gamma_{s,t}$
% defines the spatial process and how it evolves through time --- potentially
% letting ``hotspots'' remain hotspots through time while keeping the means of
% the spatial process $\gamma_{s,t}$ stationary and centred on zero.

Our \textbf{glmmfields} package fits these models in a Bayesian framework. We
sample from the posterior distribution using the No-U-Turn Sampler, which is an
extension of Hamiltonian Markov Chain Monte Carlo (MCMC), implemented in Stan
\citep{standevelopmentteam2016a, carpenter2017} and the R package \textbf{rstan}
\citep{standevelopmentteam2016}. This Bayesian approach has a number of
advantages. First, it lets us fully quantify uncertainty around all parameter
estimates and derived quantities (e.g.\ predictions, probabilities of exceeding
extremes). Second, the Bayesian framework lets us place weakly informative
priors on parameters to impose our existing knowledge of reasonable values and
to aid computation. In the case of the degrees of freedom parameter, $\nu$, we
bound the lower value to $2$ for computational stability and use a gamma(2, 0.1)
prior (i.e., shape = 2, rate = 0.1), which has a mean of $20$ and a median of
$\sim 17$ \citep{juarez2010}.

\subsection{Testing the recovery of spatial extremeness}
\label{sec:testing-recovery}

We used simulation testing to evaluate how well heavy spatial tails could be
recovered under various conditions. Our simulations included 50 data points (15
knots) collected at the same locations for 5, 15, or 25 years. The spatial
process was independent by year ($\gamma_{s,t} = W_{s,t}$) with $\sigma^2 = 1$
(the spatial variance) and $\eta = 1$ (the spatial correlation parameter).
% with spatial data locations drawn with uniform probability from 0 to 10.
We set the MVT $\nu$ parameter to 2.5 (heavy tails), 5 (moderately heavy tails),
or 20 (effectively normal tails). We then corrupted the `true' spatial process
with observation error, using a gamma distribution with a log link, $Y_{it}\sim
\mathrm{gamma}\left(a,\frac {a}{\mathbb{E}(Y_{it})} \right)$, where the shape
parameter $a$ can be re-parameterized into the coefficient of variation (CV),
$a=\frac{1}{\mathrm{CV}^2}$. We tested CVs of 0.1, 0.6, and 1.2. The underlying
linear predictor $\bm{X_{s,t}} \bm{\beta}$ was set to zero to focus on the
spatial process. Therefore, the simulation of data $y_{s,t}$ simplifies to
% \begin{align}
  $\log(\mu_{s,t}) \sim \mathrm{MVT}\left(\nu, 0, \Sigma_{W(s,t)}\right),$
  $y_{s,t} \sim \mathrm{gamma} \left( \frac{1}{\mathrm{CV}_\mathrm{obs}^2},
    \frac{1}{\mathrm{CV}_\mathrm{obs}^2 \cdot \mu_{s,t} } \right)$.
% \end{align}

We attempted to recover $\nu$ by fitting a model that matched the process
generating the simulated data. We provide a full description of the priors,
posteriors, and joint probability distributions along with details of the MCMC
sampling for this and all other models in the Supporting Information.
% TODO: make sure that all priors are listed in the supplement generating the
% simulated data. We placed weakly informative priors on $\sigma$, $\eta$, and
% CV of half-$t$(3, 0, 3) (i.e. Student-$t$(3, 0, 3)[0, $\infty$]). We

\subsection{Diagnosing the advantage of allowing for extremes}
\label{sec:diagnosing}

To evaluate the consequence of assuming spatial processes are not present when
they really are, we generated simulated data sets from a model with spatial
extremes (MVT) then compared the fit of models with and without extremes (MVT
vs.\ MVN). Specifically, we simulated data from the model:
$\mu_{s,t} \sim \mathrm{MVT}\left(\nu, 0, \Sigma_{W(s,t)}\right)$,
$y_{s,t} \sim \mathrm{normal} \left(\mu_{s,t},
  \sigma_{\mathrm{obs}} \right)$,
with $\sigma = 0.3$, $\eta = 1.2$, and 100 spatial data points. The locations of
the data, and the knots (15), were held constant through time to enable faster
computations. We set the MVT df parameter $\nu$ to 2 (very heavy tails) and used
a Gaussian observation model with standard deviation $\sigma_{\mathrm{obs}}$ of
0.8. We fit our estimation model as described above and with a half-$t$(3,0,3)
prior on $\sigma_{\mathrm{obs}}$.
% TODO: consider moving this and other priors into the supplement

To evaluate out-of-sample predictive accuracy, we withheld 10\% of the data
randomly (10 points per year) from the model fitting and then compared the MVT
and MVN models: the root mean squared error between the
$\log(\hat{\mu}^{\mathrm{withheld}}_{s,t})$ posterior medians and the true
$\log\left(\mu^{\mathrm{withheld}}_{s,t}\right)$, the width of the 95\% credible
intervals (CIs) on $\hat{\mu}^{\mathrm{withheld}}_{s,t}$, and the difference in
the leave-one-out information criteria \citep[LOOIC;][]{vehtari2017}, a Bayesian
information criteria that approximates leave-one-out predictive performance.

\subsection{Mountain pine beetles in the US Pacific Northwest}

To illustrate real-world applications of spatial models with extremes, we fit
MVT and MVN random field models to a data set representing mountain pine beetle
outbreaks in the US Pacific Northwest from 1994 to 2014
\citep{usdaforestservice2017}. We rasterized the map into a 500 by 500 grid and
then aggregated this high-resolution grid into percent cover in a coarser grid
reduced by a factor of 25.
% This maintained a reasonable resolution while limiting the data size for rapid
% model fitting.
We modelled the proportion of finer grid cells affected by outbreaks per coarser
grid cell (excluding coarser grid cells without outbreaks). Since the proportion
affected was far from $1$, we can fit a model with a log link and lognormal
observation distribution. The log of the mean proportion affected at location
$s$ and time $t$, $\mu_{s,t}$, is predicted by a year-specific random walk
defined by $\beta_t$, and the spatiotemporal process $\gamma_{s,t}$, with the
spatial process itself modelled as autoregressive: \begin{align} \log(\mu_{s,t})
  &= \beta_t + \gamma_{s,t},\\ \label{eq:beetle-mu} \beta_t &\sim
  \mathrm{normal}\left( \beta_{t-1}, \sigma_{\beta} \right), \\ \gamma_{s^{*},t}
  &\sim \mathrm{MVT}\left(\nu, \phi \gamma_{s^{*},t-1},
    \Sigma_{W(s^{*},t)}\right). \end{align}

\noindent Furthermore, we model the data, $y_{s,t}$, as generated by a lognormal
observation model with scale parameter $\sigma_{\mathrm{obs}}$: $y_{s,t} \sim
\mathrm{lognormal} \left(  \log(\mu_{s,t}), \sigma_{\mathrm{obs}} \right)$.

We used 20 knots to represent the spatial process
% TODO: make sure knots are correct
(increasing the number of knots did not substantially affect the results). We
compared the above MVT model to a Gaussian random field model. To evaluate
out-of-sample predictive accuracy we withheld 25 randomly selected data points
per year from the model fitting, for a total of 400 withheld data points, or
approximately 10\% of the data. We then compared the log predictive density for
the held-out data and the width of the 95\% CIs
% from the MVN and MVT models, and the leave-one-out-information-criterion
(details, including priors in Supporting Information).

\section{Results}

Under most scenarios we were able to recapture true values of $\nu$ with
reasonable accuracy and low bias (Fig.~\ref{fig:recapture}a--c). The number of
time steps had the largest effect on detecting low values of $\nu$. For example,
the median absolute proportional error between $\nu$ and $\hat{\nu}$ (median of
the posterior) was only \mapeTwentyFive\ with 25 time steps, minimal observation
error (CV = 0.1), and $\nu = 2.5$ (Fig.~\ref{fig:recapture}b). However, the
median absolute proportional error increased by approximately
\mapeFifteenIncFold - and \mapeFiveIncFold -fold when the number of time steps
was reduced to 15 and 5, respectively (Fig.~\ref{fig:recapture}b). Observation
error did not substantially affect the estimation of $\nu$ until relatively high
levels of observation error (i.e.\ CV = 1.2, Fig.~\ref{fig:recapture}c).

When the true underlying data were generated with spatiotemporal extremes (MVT,
$\nu = 2$), fitting a model without extremes reduced out-of-sample predictive
accuracy and precision (Fig.~\ref{fig:recapture}d--f). The MVN model tended to
overestimate $\sigma$ (which controls the magnitude of the random field
deviations) to account for effectively fixing $\nu = \infty$ (e.g.\
Fig.~\ref{fig:recapture}d). The out-of-sample RMSE was slightly higher for the
misspecified MVN model compared to a correctly specified MVT model (median RMSE
= \rmseWrong\ vs.\ \rmseRight; Fig.~\ref{fig:recapture}e). The out-of-sample MVN
model CIs were a median of \medianMedianCIWiderSim \% larger than the MVT model
CIs. The leave-one-out information criterion (LOOIC) correctly chose the MVT
model in \looCorrectSim \% of the simulations.

For the pine beetle case study, the spatial model with extremes generated more
accurate and precise out-of-sample predictions (Fig.~\ref{fig:map-etc}). The
estimates of $\nu$ indicated heavy tails in the spatiotemporal process (median
$\nu = \nuBeetleMedian$, 95\% CI = $\nuBeetleLower$ -- $\nuBeetleUpper$,
Fig.~\ref{fig:map-etc}c). Advantages of the MVT model over the MVN included
greater log predictive density for held-out data (Fig.~\ref{fig:map-etc}d)
% smaller values of LOOIC (SE = XX),
and a median of \medianPercSmallerCIsBeetles \% narrower 95\% CIs. Predictions
from the MVT model demonstrate evolving hotspots of pine beetle infestation in
the US Pacific Northwest, with particularly strong hotspots in 2009--2010
(Fig.~\ref{fig:beetle-pred}).


\section{Discussion}

We have introduced a spatial process model that models random fields through
time with a MVT rather than MVN distribution. Through simulation, we demonstrate
the advantages of this new model; when spatiotemporal extremes exist in
simulated data, our MVT model has superior predictive accuracy and precision.
Using a case study on mountain pine beetle outbreaks in the Pacific Northwest,
we show that our MVT model produces more accurate and precise out-of-sample
predictions compared to a MVN model. Because the MVT model converges to the MVN
model and only requires estimating one additional parameter, we recommend
fitting the MVT model even if anomalous events are not thought to be present
\textit{a priori}.

Many ecological, environmental, and anthropogenic processes could generate
spatiotemporal extremes. For example, unmodelled animal movement such as changes
to the shoaling behaviour of fish with population density declines
\citep[][]{rose1999} could generate apparent extremes. Another possible cause
could be spatial climate anomalies. For instance, a series of abnormally warm
winters around 1990 led to a sudden northward shift in juvenile cod and low
abundance in the southern North Sea since \citep{rindorf2006}. In southern
Australia, several weeks of extreme warm water temperatures led to the sudden
range contraction of a brown alga seaweed \citep{smale2013}. Heat waves can also
increase the likelihood of wildfires or disease outbreaks (e.g. REF), which
could generate spatial extremes through time. Additionally, human-caused
disasters, such as marine oil spills could cause extremes in spatial patterns
through time. In essence, the MVT random fields model allows for unexpected and
unmodelled events to occur and have less influence on parameter estimates and
predictions.

% For example, several weeks of extreme warm water temperatures caused a sudden
% 100 km range contraction for a brown alga seaweed species off Southern Australia
%     in 2011 [@smale2013]. In the North sea, a series of abnormally warm winters
%     around 1990 led to a sudden northward shift in juvenile cod and low
%     abundance in the southern North Sea since [@rindorf2006]. I think both those
%     examples for the discussion work well. I was also thinking about climate -
%     disease interactions as another mechanism. Something like this:
%     http://ajph.aphapublications.org/doi/abs/10.2105/AJPH.91.8.1194 (it's human
%     health, but that's probably ok -- there's other examples for animals)


For our case study of pine beetle outbreak coverage, the MVT model provided
better out-of-sample predictive ability and greater precision compared to the
same model with a MVN random field. We did not link covariates to the mean
response, but it is possible that their inclusion could help explain the spatial
anomalies. Importantly, our model is descriptive rather than dynamic
\citep{cressie2011}. A dynamic model would include mechanisms governing the
spatial evolution of the pine beetle outbreaks (such as XX REF), and these
mechanisms could generate the extremes we observe with our descriptive model.
Alternatively, incorporating spatiotemporal extremes into a dynamic model of
pine beetle outbreaks might improve its predictive capacity.

Our associated R package, \textbf{glmmfields}, is designed to be familiar for
anyone who has fit GLMs in R, and includes flexibility for many features beyond
those described so far. For example, \textbf{glmmfields} can be used to fit
spatial GLMs for data without a temporal component (Appendix XX). The package
can fit observation models beyond those included in this paper, such as Poisson,
negative binomial, or binomial, and can include numeric or factor covariates.
% In addition to fixed, independent, and random walk temporal processes, the
% package can fit exchangeable time effects constrained by a Gaussian
% distribution (i.e. ``random effects''). , and allows for flexibility in how
% the spatial process evolves (static field, fields modelled as AR1, fields
% modelled as a random walk, and independent exchangeable fields).
\textbf{glmmfields} includes familiar R utility functions (e.g.\
\texttt{predict}) and plotting functions for model checking. Furthermore, the
package includes a simulation function that can simulate data from any model the
package can fit, and a series of unit tests that simulate and fit all major
model configurations.

There are limitations to the approach we have described. First, spatial
predictive models require the selection of knots; too few may not characterize
the spatial field accurately, biasing parameter estimates. The spatial process
may also be poorly described by a MVT or MVN random field and be better
described by some other form \citep[e.g.\ see][]{conn2015}. While the MVT
spatial model is more robust than the MVN model, better predictions and
inference might be obtained by explicitly modelling the processes that generated
the extremes. Also, the MVT random fields model requires a sufficient number of
observations and sufficiently low sampling error to detect spatial extremes
(though when extremes cannot be detected, the model converges to the MVN model).

Our MVT spatial model uses a predictive approach to achieve considerable
efficiency over modelling a full covariance matrix describing all observed
locations. However, an important topic for research is to include sparse matrix
algorithms in spatiotemporal models of extremes. A recent advance to spatial
models with large datasets has been the stochastic partial differential equation
(SPDE) approximation to GRFs proposed by \citet{lindgren2011}. These methods are
accessible via the integrated nested Laplace approximation
\citep[INLA,][]{rue2009}, which allows for approximate Bayesian sampling of the
posterior without MCMC. Use of the SPDE-INLA approach has increased rapidly in
ecology over the last five years \citep[e.g.][]{illian2013, ono2016}, and is
significantly faster than other approaches, in part because of integration with
Template Model Builder through software such as VAST \citep{thorson2017}.
Regardless, the MVT random field model introduced here is already efficient,
accessible to a wide range of ecologists and environmental scientists through
the included R package, and allows us to improve predictions for ecological
processes with extreme spatial anomalies through time.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



% One of the biggest hurdles in identifying support for MVT spatial fields
% (small estimated df parameter) is using spatiotemporal data sets that have
% enough time slices to capture extreme events. [tie into sim results]. The
% ability to detect spatial anomalies in ecological processes may also be
% affected by the number or selection of knots, however our results show that
% spatial extremes can be identified even using a small numbers of knots. Like
% other state-space models, inference about spatial extremes may be corrupted by
% observation error (both the observation model, and magnitude). Our results
% indicate that spatial events can be identified with moderate to high
% observation error (coefficient of variation ~ 1).
%
% As complex spatial models have become more user-friendly, we expect the rapid
% use of spatiotemporal models to be continued. Examples of possible
% applications beyond bark beetles include to models of fisheries (cite Thorson
% ECE paper), applications to climate anomalies
% (http://www.pnas.org/content/106/Supplement\_2/19723.short), or to other
% disturbances - wildfires, oil spills, and disease outbreaks.]
%
% There are a number of features included in the 'glmmfields' package that may be
% useful to ecologists, but beyond the scope of this paper. Examples of features
% include the addition of covariates (numeric or factors), models for temporal
% processes (random effects), and flexible models for the evolution of the spatial
% process (a static field shared across time, fields modelled as an AR(1) process,
% or fields modelled as exchangeable). Like GLMs, we have also provided a range of
% commonly encountered discrete and continuous observation models to fit a wide
% range of data types.

\section{Acknowledgements}

We thank T.A. Branch and J.T. Thorson for helpful discussions on the modeling
approach and B.J. Harvey for helpful advice on the mountain pine beetle data. We
are grateful to the maintainers of the U.S. Forest Service Insect and Disease
Survey Database. Funding was provided by a David H. Smith Conservation Research
Fellowship to S.C.A.
All code and data associated with this paper are available at
\url{https://github.com/seananderson/spatial-extremes} and are archived at
\url{https://zenodo.org/XX}.
The R package \textbf{glmmfields} is available at
\url{https://github.com/seananderson/glmmfields}.

\setlength{\bibsep}{0pt plus 0ex}

\bibliography{spatial-extremes}

\clearpage

\section{Figures}

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.55\textwidth]{../figs/nu-rf-illustration-small.pdf}
    \caption{An illustration of three draws from a MVN random field (top row)
      vs.\ three draws from a MVT random field with heavy tails
      (degrees of freedom, $\nu$, of 2; bottom row).
      Draws represent slices of time with independent spatial
      processes at each time slice.
      Random seeds are held constant between the rows
      to illustrate the difference.
      Note the considerably more extreme values in
      the second draw for the MVT spatial process.}
    \label{fig:nu}
  \end{center}
\end{figure}

\clearpage

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.8\textwidth]{../figs/simulation-results.pdf}
    \caption{Simulation testing the MVT random fields model.
      Upper row
      panels illustrate the ability to recapture the
      degree of spatial heavy tailedness.
      Shown are tests with
      (a) various true values of $\nu$ (the MVT degrees of freedom parameter),
      (b) an increasing number of time steps in the data set (with low observation error),
      and (c) an increasing level of observation error.
      The full factorial results are shown in Fig.~\ref{fig:recapture-factorial}.
      Individual dots show the median estimates from individual simulation runs.
      % Polygons show the density of the distribution of estimates.
      The colour scale indicates the true degree of heavy tailedness from
      yellow (effectively normal) to red (very heavy tailed).
      % The parameter $\nu$ has a lower limit of $2$ in the model
      % for computational stability.
      Lower row panels illustrate the impact of fitting MVN and MVT models
      when the true underlying data are drawn from MVT random fields.
      (d) Parameter posteriors for an
      example model fit of a mismatched MVN model (orange)
      and a correct MVT model (blue) (black crosses indicate true values).
      (e) Percent greater root mean squared error (RMSE)
      and (f) $\Delta$ LOOIC (leave-one-out information criteria)
      for the mismatched MVN model compared to the correct MVT model.
    }
    \label{fig:recapture}
  \end{center}
\end{figure}

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.8\textwidth]{../figs/beetle-performance.pdf}
    \caption{
      Model fit characteristics of autoregressive random field
      models fit to mountain pine beetle data from the US Pacific Northwest.
      (a) Map of the region with tree mortality observations for one year shown with
      brown dots.
      (b) Photograph of a pine beetle infested forest in British Columbia, Canada.
      (c) Posterior and prior distributions of the degrees of freedom parameter, $\nu$.
      Low $\nu$ values (approximately $\nu < 10$) indicate evidence of heavy-tails.
      (d) Log predictive density for held-out data for MVT (blue) and MVN (orange) models.
      (e) The ratio of 95\% CI widths between the MVN and MVT models.
    }
    \label{fig:map-etc}
  \end{center}
\end{figure}

\clearpage

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.65\textwidth]{../figs/beetles-mvt-predictions.pdf}
    \caption{Modelled severity of mountain pine beetle outbreaks in Washington and
      Oregon State in the United States from 1999 to 2014.
      Shown are medians of the modelled parameter $\mu_{s,t}$ from Equation 1
      --- a autoregressive spatiotemporal MVT random fields model.
    }
    \label{fig:beetle-pred}
  \end{center}
\end{figure}

% \end{flushleft}

\end{spacing}

\begin{spacing}{1.4}

\clearpage

\section{Supporting Information}

\subsection{Posterior and joint distributions}

In this section, for clarity, we use the notation $[a|b]$ to describe the
conditional distribution of $a$ given $b$. The joint posterior distribution for
the model in the section \textit{\nameref{sec:testing-recovery}} can be written
as:
\begin{equation}
  [
  \bm{\gamma},
  \eta,
  \nu,
  \mathrm{CV}_\mathrm{obs},
  \sigma^2
  |
  \bm{y}]
  \propto
  [y_{s,t} | \gamma_{s^*,t}, \mathrm{CV}_\mathrm{obs}]
  [\gamma_{s^*,t} | \eta, \nu, \sigma^2]
  [\eta]
  [\nu]
  [\mathrm{CV}_\mathrm{obs}]
  [\sigma^2],
\end{equation}

\noindent where the parameters are defined in the main Methods section.
Importantly, we use parameters with an asterisk ($\gamma_{s^{*},t}$) to describe
the random effects at the locations of the unobserved knots, and parameters
without the asterisk ($\gamma_{s,t}$) to describe the projected random effects
at the locations of observed data (projection equation in main text). The joint
probability is calculated over points in space $s$, and time $t$. Missing
observations or replicate observations for given points in space and time may be
present.

The joint posterior distribution for the model in the section
\textit{\nameref{sec:diagnosing}} can be written as:
\begin{equation}
  [
  \bm{\gamma},
  \eta,
  \nu,
  \sigma^2_{\mathrm{obs}},
  \sigma^2
  |
  \bm{y}]
  \propto
  [y_{s,t} | \gamma_{s^*,t}, \sigma^2_{\mathrm{obs}}]
  [\gamma_{s^*,t} | \eta, \nu, \sigma^2]
  [\eta]
  [\nu]
  [\sigma^2_{\mathrm{obs}}]
  [\sigma^2],
\end{equation}

\noindent
and the joint posterior distribution
for the model of mountain pine beetle outbreaks can be written as:
\begin{multline}
  [
  \bm{\beta},
  \bm{\gamma},
  \phi,
  \eta,
  \nu,
  \sigma^2_{\mathrm{obs}},
  \sigma^2_{\beta},
  \sigma^2
  |
  \bm{y}]
  \propto \\
  [y_{s,t} | \beta_{t}, \gamma_{s^*,t}, \sigma^2_{\mathrm{obs}}] \\
  \times
  [\beta_t | \beta_{t-1}, \sigma^2_{\beta}] \\
  \times
  [\gamma_{s^*,t} | \gamma_{s^*,t-1}, \phi, \eta, \nu, \sigma^2] \\
  \times
  [\beta_{t=1}]
  [\gamma_{s^*,t=1}]
  [\phi]
  [\eta]
  [\nu]
  [\sigma^2_{\mathrm{obs}}]
  [\sigma^2_{\beta}]
  [\sigma^2].
\end{multline}

\subsection{MCMC sampling details}

For the models fit to the simulated datasets, we initially sampled from each
model with 500 iterations across four chains discarding the first half of the
iterations as warm-up. If the samples had not converged after this initial run,
we re-sampled from the model with 2000 iterations across four chains. For the
models fit to the mountain pine beetle data, we sampled TODO iterations,
discarding the first half as warm-up. We measured convergence as a minimum
effective sample size of $\ge 100$ and a maximum $\hat{R}$ of $\le 1.05$) across
all parameters.

\subsection{Model comparison}

We compared MVN and MVT models via log predictive density, $\Delta$ LOOIC
(leave-one-out information criteria), RMSE (root mean squared error), and
credible interval width. We calculated the log predictive density (lpd) as:

\begin{equation}
  \mathrm{lpd} = \sum^{S}_{s=1}{ \sum^{T}_{t=1}{ \log  p(\mu_{s,t} | \widehat{y_{s,t}}, \theta)}},
\end{equation}

\noindent where $\mu_{s,t}$ represents the true (unobserved) response value at
location $s$ and time $t$, $\widehat{y_{s,t}}$ indicates the predicted
response value at location $s$ and time $t$, and $\theta$ represents estimated
parameters. We display the distribution of these quantities across MCMC
samples.

The Bayesian LOO (leave-one-out) estimate of out-of-sample
predictive fit $\mathrm{elpd}_\mathrm{loo}$ is defined as:
\begin{equation}
  \mathrm{elpd}_\mathrm{loo} = \sum^{n}_{i=1}{\log ( p(y_i | y_{-1}) },
\end{equation}

\noindent where

\begin{equation}
  p(y_i | y_{i-1}) = \int p(y_i | \theta) p (\theta | y_{-i}) d \theta ,
\end{equation}

\noindent is the predictive density given the data without the $i$th data point
\citep{vehtari2017}. For computational efficiency, the LOO R package calculates
LOOIC using an approach called Pareto smoothed importance sampling
\citep{vehtari2017}. We calculated $\Delta$LOOIC as
$\mathrm{LOOIC}_\mathrm{MVT} - \mathrm{LOOIC}_\mathrm{MVN}$.

We calculated the root mean squared error (RMSE) of predictions as:

\begin{equation}
  \sqrt{ \sum^{T}_{t=1}{ \sum^{S}_{s=1}{ \log(\mu_{s,t}) - \log(\widehat{ \mu_{s,t} })^2 } } },
\end{equation}

\noindent where $\widehat{\mu_{s,t}}$ represents the median of the posterior of
$\mu_{s,t}$. Finally, we calculated the ratio of the credible interval
widths as:

\begin{equation}
\frac{
\mathrm{CI}_\mathrm{MVN}^\mathrm{upper} - \mathrm{CI}_\mathrm{MVN}^\mathrm{lower}
}{
\mathrm{CI}_\mathrm{MVT}^\mathrm{upper} -
\mathrm{CI}_\mathrm{MVT}^\mathrm{lower}
},
\end{equation}

\noindent where $\mathrm{CI}_\mathrm{MVN}^\mathrm{upper}$, for example,
represents the upper 95\% quantile-based credible interval of
$\widehat{\mu_{s,t}}$ for the model assuming MVN random fields.

\clearpage

\end{spacing}

\renewcommand{\thefigure}{S\arabic{figure}}
\renewcommand{\thetable}{S\arabic{table}}
\setcounter{figure}{0}
\setcounter{table}{0}

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.7\textwidth]{../figs/pp-illustration.pdf}
    \caption{
      Illustration of the steps to fitting a predictive process model.
      First we observe spatial data, we select knot locations,
      and we calculate the covariance between the knots and the observed data.
      Then we fit the model with the knots and data remaining constant throughout.
      For each MCMC iteration, values are proposed for the
      knots, those values are projected from the knots to the locations of the observed data,
      and the likelihood is evaluated at the locations of the observed data.}
    \label{fig:didactic}
  \end{center}
\end{figure}
% Might be good to just clarify the values being proposed are values of observed data - not spatial locations

\clearpage

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.90\textwidth]{../figs/sim-recapture.pdf}
    \caption{
      Full factorial results from the simulation shown in Fig.~\ref{fig:recapture}.
      Individual dots show the median estimates from individual simulation runs.
      Polygons indicate probability density of the median estimates of
      individual simulation runs.
      The colour scale indicates the true degree of heavy tailedness from
      yellow (effectively normal) to red (very heavy tailed).
    }
    \label{fig:recapture-factorial}
  \end{center}
\end{figure}

\renewcommand\theadfont{\scriptsize}
\renewcommand\theadalign{cl}

\begin{landscape}
  \begin{table}
    \begin{minipage}{\textwidth}
    \caption{
      Comparison of select R packages for spatiotemporal analysis with random fields.
    }
    \label{tab:packages}
    \begin{scriptsize}
      \begin{tabular}{llllL{2cm}lL{2.4cm}lL{2.0cm}llL{2.0cm}}
        \toprule
        Package  & \thead[l]{MVT \\ random \\ fields} & \thead[l]{Formula          \\ interface} & \thead[l]{Multi-                                                 \\ variate} & Estimation              & \thead[l]{Simulation \\ function} & \thead[l]{Observation                                      \\ model} & \thead[l]{Maximum \\ likelihood \\ estimation} & \thead[l]{Covariance \\ functions} & \thead[l]{AR Spatial \\ Fields} & \thead[l]{Dynamic \\ Linear \\ Models} & URL \\
        \midrule
        spTimer  & No             & Yes     & No      & MCMC                        & No         & Gaussian                                                          & No       & Exponential, Gaussian, Matern family, spherical   & Yes                   & No        & \url{https://CRAN.R-project.org/package=spTimer} \\
        spate    & No             & No      & No      & MCMC/SPDE                   & Yes        & Gaussian, skewed Tobit                                            & Yes      & Matern family                                     & No                    & No        & \url{https://CRAN.R-project.org/package=spate} \\
        spBayes  & No             & Yes     & Yes     & MCMC                        & No         & Gaussian, binomial, Poisson                                       & No       & Exponential, Gaussian, Matern family, spherical   & No                    & Yes       & \url{https://CRAN.R-project.org/package=spBayes} \\
        INLA     & No             & Yes     & Yes     & Approximate posterior/SPDE  & Yes        & Many                                                              & Yes      & Exponential, Gaussian, Matern family, many others & Yes                   & Yes       & \url{http://www.r-inla.org/}                                     \\
        VAST     & No             & No      & No      & Maximum likelihood/SPDE     & Yes        & Gaussian, lognormal, gamma, binomial, Poisson, negative binomial  & Yes      & Matern family                                     & Yes                   & No        & \url{https://github.com/James-Thorson/VAST}                      \\
        glmmfields & Yes            & Yes     & No      & MCMC/NUTS                   & Yes        & Gaussian, lognormal, gamma, binomial, Poisson, negative binomial  & No       & Exponential, Gaussian, Matern family              & Yes                   & Yes       & \url{https://github.com/seananderson/glmmfields}                  \\
        \bottomrule
      \end{tabular}
    \end{scriptsize}
  \end{minipage}
  \end{table}
\end{landscape}

\end{document}
