\documentclass[12pt,english]{article}
\usepackage{geometry}
\geometry{verbose, letterpaper, tmargin = 2.54cm, bmargin = 2.54cm,
  lmargin = 2.54cm, rmargin = 2.54cm}
\geometry{letterpaper}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{setspace}
\usepackage{url}
\usepackage{lineno}
\usepackage{xcolor}
\usepackage{bm}
\renewcommand\linenumberfont{\normalfont\tiny\sffamily\color{gray}}
\modulolinenumbers[2]
\usepackage{booktabs}
\usepackage{bm}
\textheight 22.0cm
\usepackage{mathptmx}

% Linux Libertine:
% \usepackage{textcomp}
% \usepackage[sb]{libertine}
% \usepackage[varqu,varl]{inconsolata}% sans serif typewriter
% \usepackage[libertine,bigdelims,vvarbb]{newtxmath} % bb from STIX
% \usepackage[cal=boondoxo]{mathalfa} % mathcal
% \useosf % osf for text, not math
% \usepackage[supstfm=libertinesups,%
%   supscaled=1.2,%
%   raised=-.13em]{superiors}

% Fix line numbering and align environment
% http://phaseportrait.blogspot.ca/2007/08/lineno-and-amsmath-compatibility.html
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
  \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
  \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
  \renewenvironment{#1}%
     {\linenomath\csname old#1\endcsname}%
     {\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
  \patchAmsMathEnvironmentForLineno{#1}%
  \patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
\patchBothAmsMathEnvironmentsForLineno{equation}%
\patchBothAmsMathEnvironmentsForLineno{align}%
\patchBothAmsMathEnvironmentsForLineno{flalign}%
\patchBothAmsMathEnvironmentsForLineno{alignat}%
\patchBothAmsMathEnvironmentsForLineno{gather}%
\patchBothAmsMathEnvironmentsForLineno{multline}%
}

% remove numbers in front of sections:
\makeatletter
\renewcommand\@seccntformat[1]{}
\makeatother

\newcommand{\R}[1]{\label{#1}\linelabel{#1}}
\newcommand{\lr}[1]{line~\lineref{#1}}

\usepackage{pdflscape}
\usepackage{makecell}
\usepackage{array}
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
% \usepackage{parskip}
% \setlength{\parindent}{0pt}
% \setlength{\parskip}{1\bigskipamount plus \smallskipamount minus \smallskipamount}
\usepackage{ragged2e}
\usepackage[round,sectionbib]{natbib}
\bibpunct{(}{)}{;}{a}{}{;}
\bibliographystyle{ecology}

\title{
  Black swans in space:
  robust modelling of extreme spatiotemporal processes}
\author{
Sean C. Anderson$^{1\ast}$ and
Eric J. Ward$^2$
}
\date{}

\begin{document}


\maketitle

$^1$School of Aquatic and Fishery Sciences, Box 355020, University of
Washington, Seattle, WA 98195, USA

$^2$Conservation Biology Division, Northwest Fisheries Science Center, National
Marine Fisheries Service, National Oceanographic and Atmospheric Administration,
2725 Montlake Blvd E, Seattle, WA 98112, USA

$^{\ast}$Corresponding author. Present address:
Aquatic Resources, Research and Assessment Division,
Fisheries and Oceans Canada,
Pacific Biological Station,
3190 Hammond Bay Road,
Nanaimo, BC, V6T 6N7, Canada

\RaggedRight
\hyphenpenalty=500

% \begin{spacing}{1.4}
\begin{spacing}{1.9}
% \begin{flushleft}
\linenumbers

\begin{abstract}

In ecological systems, extremes can happen
in time, such as population crashes,
or in space, such as rapid range contractions.
However, current methods for
joint inference about temporal and spatial dynamics
(spatiotemporal modelling with Gaussian random fields)
may perform poorly when
underlying processes include extreme events.
Here we introduce a model that allows for extremes
to occur simultaneously in time and space.
Our model is a Bayesian predictive-process model
that uses a multivariate-t distribution to describe spatial random effects.
The approach is easily implemented with
our flexible R package \textbf{rrfields}.
First, using simulated data,
we demonstrate the ability to recapture spatiotemporal extremes,
and explore the consequences of fitting models that ignore such extremes.
Second, we predict
tree mortality from mountain pine beetle (\emph{Dendroctonus ponderosae})
outbreaks in the US Pacific Northwest over the last 16 years.
We show that our approach provides
more accurate and certain predictions
compared to traditional spatiotemporal models
that do not allow for extremes.
% TODO: tighten up these last  sentences:
Jointly modelling ecological processes in time and space
while allowing for outlying events
represents an important step forward in ecological modelling
particularly given projected trends in climate forcing and an increasing
need to focus on variability and extremes in ecological processes.
Our R package will make these models
accessible to a wide range of ecologists
and scientists in other disciplines interested in
allowing for extreme events and
in random fields spatial or spatiotemporal modelling in general.

\end{abstract}

\section{Introduction}

% TODO: cite \citep{conn2015}

Applications of statistical models that allow for joint inference about spatial
and temporal dynamics have advanced rapidly in ecology over the last several
decades \citep[e.g.][]{bascompte1995, latimer2009}. Spatiotemporal models have
also been widely used in other disciplines, including applications to weather,
remote sensing, human disease dynamics, and crime \citep{cressie2011}. When
ecological data are spatially structured, explicitly accounting for spatial
autocorrelation improves model predictions and inference about parameters of
interest --- including recommendations used in management or conservation
planning (REF).

Including spatial components in statistical models involves extending models
that most ecologists are already familiar with, such as generalized linear
models (GLMs) or generalized additive models (GAMs). Spatial relationships can
be included as predictors in models of the mean (such as in a 2-dimensional
GAM) or can be included in models of the covariance (e.g.\ kriging). Recent
extensions of these spatial covariance models include modelling spatial
deviations in GLMs or GAMs as mixed effects (Gaussian random
fields, GRFs). Examples of these methods in existing R packages include but are not
limited to \textbf{spBayes} \citep{finley2007}, \textbf{spTimer}
\citep{bakar2015}, \textbf{INLA} \citep{rue2009}, \textbf{RandomFields}
\citep{schlather2016}, and \textbf{spate} \citep{sigrist2015}
(Table~\ref{tab:packages}).

A limitation of spatial models that use GRFs is that they
may perform poorly when underlying data include anomalous or extreme events.
When models describing the spatial process also include an observation model,
for example, anomalous observations may be reconciled by increasing the variance
of the observation model (rather than attributing these to extremes in the
ecological process). Extremes in temporal processes have been modelled using a
variety of methods in ecology, typically by including mixtures of normal and
heavy-tailed distributions \citep[e.g.][]{everitt1996, ward2007, thorson2011}.
More recently, the Student-$t$ distribution has been proposed as a
solution to modelling process variation with extremes in population dynamics
\citep{anderson2017}.

Several extensions of GRFs have been proposed to better capture
extreme spatial events, including max-stable or extreme value theory
\citep{davison2012, davison2012a}, where quantities of interest include probabilities
of exceeding some threshold \citep{davis2008}. Other extensions of spatiotemporal
models to describing extremes include the use of multivariate-$t$ (MVT) spatial
random fields \citep{roislien2007}. Focusing on the latter, to our knowledge these
methods have not been applied in the ecology, fisheries, or environmental sciences.

In this paper we introduce the use of robust spatial predictive models using
the MVT distribution, and provide a user-friendly implementation in our new
R package \textbf{rrfields} (robust random fields). Using simulation testing
to compare the multivariate normal (MVN) to MVT spatial processes, we
illustrate that the MVT leads to better prediction (greater accuracy, more
precision) when the underlying special process is heavy-tailed. We then
illustrate the application of this approach to real-world data that includes
spatial extremes, using data on mountain pine beetle (\textit{Dendroctonus
  ponderosae}) outbreaks in the Pacific Northwest of the United States.

\section{Methods}

We seek to allow for large deviations in an ecological spatial pattern over
time by extending a spatiotemporal predictive process model to use a MVT
distribution instead of the MVN distribution. Below we describe the form of
our model as implemented in \textbf{rrfields}, describe two simulation tests
exploring model performance, and finally describe the application of our model
to a data set of mountain pine beetle outbreaks.
A complete reproducible version of this analysis is available at
\url{https://github.com/seananderson/spatiotemporal-extremes} DOI: TODO.

\subsection{The MVT predictive process model}

\citet{latimer2009} provide an overview of predictive process models for
ecologists. For large datasets (hundreds of locations), the dimensionality of the random
effects may be computationally prohibitive. One solution is to estimate the random
field as correlated random effects at a subset of locations or $m$ 'knots'
\citep[e.g.][]{latimer2009, shelton2014}, where $m < n$, the number of data points. The
$m$ knots describing a random field can be estimated via a clustering algorithm,
such as the partitioning around medoids
algorithm \citep[the \texttt{pam} function in the R package
\textbf{cluster};][]{reynolds2006}.
Instead of estimating an unconstrained $m \times m$ covariance matrix, a covariance
function is specified \emph{a priori} to model covariance as a function of distance.
Our package allows the isotropic Gaussian, exponential, and Matern covariance functions,
however anisotropic functions could be included. Given the random
effects estimated at the knot locations, and known distance matrix between the knots
and observed data, the knot random effects can be projected to the locations of the
observations \citep[][Figure~\ref{fig:didactic}]{latimer2009, finley2009}.

As an example, the commonly used squared exponential (Gaussian) covariance function
models the correlation between points $i$ and $j$ as $H(\delta_{ij}) = \exp
\left(-\frac{\delta_{ij}^2}{2 \eta} \right)$, where $\delta_{ij}$ is the
distance between points $i$ and $j$ and $\eta$ controls how steeply
correlation declines with distance. For a given set of $\delta_{ij}$,
large values of $\eta$ correspond to smooth spatial patterns and small values
correspondence to wiggly spatial patterns --- the degree of wiggliness implied by
a value of $\eta$ depends on the scale of the $\delta_{ij}$. The elements of the
covariance matrix $\Sigma$ at the $m$ knot locations are then
defined as $\Sigma_{ij}^*=\sigma^2 \left( \frac{-\delta_{ij}^2}{2 \eta} \right)$ with the
parameter $\sigma$ scaling the amplitude of the spatial deviations.
Following \citet{latimer2009}, we can calculate the
covariance matrix between the locations of the data and the knots,
$\Sigma_{\left(W, W^* \right)}$.
% Each element of the covariance matrix $\Sigma^*$ is thus dependent on
% three quantities: (1) $\delta_{ij}$ the known distance between points $i$ and
% $j$ squared, (2) the scale parameter $\phi$, which determines how steeply the
% correlation declines with increasing distance, and (3) the variance $\sigma^2$.
locations $W_t^*$ by drawing from a multivariate distribution (MVN, MVT) with covariance
$\Sigma^*$ and project these to the data locations using
$\Sigma_{\left( W,W^{*} \right)}$:
$W=\Sigma_{\left(W,W^* \right)}^{'} \Sigma^{*-1}W^*$.

Here, we summarize the important features of these models and highlight how
our new MVT model differs from the MVN version. Both models are
essentially GLMMs with a spatiotemporal element described by random field.
The expected value of the response, $\mu
\equiv \mathbb{E}(y)$, at a set of locations in space $s$ and time $t$ is
% maybe make these inline?
\begin{equation}
  g(\mu_{s,t}) = \bm{X}_{s,t} \bm{\beta} + \gamma_{s,t},
\end{equation}

\noindent where $g$ is a link function,
$\bm{X}_{s,t}$ represents predictors, and $\bm{\beta}$ is estimated coefficients.
The symbol $\gamma$ represents the spatiotemporal process,
described below. The variance of the observation component of
our model is a function of the mean via a
probability distribution such as the Gaussian, Poisson, or gamma.

%A random field is a term used to describe ``random effects'' drawn from a
%multivariate probability distribution representing deviations in a
%two-dimensional space (REF).
Modifying the MVN spatiotemporal model
to the more flexible MVT distribution involves one extra
degrees of freedom parameter $\nu$. When $\nu$ is small (say $\nu < 10$)
the distribution has heavier tails than the MVN --- meaning, extreme events
are more likely (Fig.~\ref{fig:nu}). For most purposes, the MVT and MVN are
indistinguishable for moderate values of $\nu$ (say $\nu > 20$) similarly to the
univariate t-distribution compared with the univariate normal distribution
\citep[e.g.][]{anderson2017}.

If $W_{s,t}$ defines a random field, then the spatiotemporal element,
$\gamma_{s,t}$, can be made temporally constant (one field shared across time,
$\gamma_{s,t} = W_{s}$), independent at each time step ($\gamma_{s,t} =
W_{s,t}$), or autoregressive so that the spatial pattern at time $t$ is
dependent on the spatial pattern at time $t-1$ to a degree defined by $\phi$,
($\gamma_{s,t} = \phi \gamma_{s,t-1} + W_{s,t}$).
% In the last case,
% we constrain the spatiotemporal autoregressive process to be centred on zero at
% each time step to aid interpretation and ensure identifiability ($\gamma_{s,t}
% = \phi (\gamma_{s,t-1} - \mathbb{E}[\gamma_{t-1}]) + W_{s,t}$). This lets the
% mean process be defined by the linear predictor ($\bm{X_{s,t}}\bm{\beta}$)
% while $\gamma_{s,t}$ defines the spatial process and how it evolves through
% time --- potentially letting ``hotspots'' remain hotspots through time while
% keeping the means of the spatial process $\gamma_{s,t}$ stationary and centred
% on zero.

Our package fits these models in a Bayesian framework. We sample
from the posterior distribution using the No-U-Turn Sampler, which is an
extension of Hamiltonian Markov Chain Monte Carlo, implemented in Stan
\citep{standevelopmentteam2016a, carpenter2017}
and the R package \textbf{rstan} \citep{standevelopmentteam2016}.
This Bayesian approach has a
number of advantages. First, it lets us fully quantify
uncertainty around all parameter estimates and derived quantities (e.g.\ predictions,
probabilities of exceeding thresholds or extremes). Second, the Bayesian framework
lets us place weakly informative priors on parameters to impose our existing
knowledge of reasonable values and to aid computation --- particularly for
difficult to estimate
parameters. In the case of
the degrees of freedom parameter, $\nu$, we bound the lower value to $2$ for
computational stability and use a gamma(2, 0.1) prior (i.e., shape = 2, rate = 0.1),
which has a mean of $20$ and a median of $\sim 17$ \citep{juarez2010}.
If the data are not informative about heavy
tails, our estimate of $\nu$ should approximately match the prior.

\subsection{Testing the recovery of extremeness}

We used simulation testing to evaluate how well we could recover
heavy spatial tails under various conditions.
Our simulations included 50 data points (15 knots) collected at the same
locations each year for 5, 15, or 25 years. The spatial process was simulated
as independent each year ($\gamma_{s,t} = W_{s,t}$) with $\sigma^2 = 1$
(the spatial variance),
$\eta = 1$ (the wiggliness or spatial correlation parameter), and
with spatial data locations drawn uniformly from 0 to 10.
The MVT df parameter $\nu$ was set to 2.5 (heavy tails), 5 (moderately
heavy tails), or 20 (effectively normal tails). A final step in our data
simulation was to corrupt the ``true'' process with observation error. We used a gamma
distribution with a log link, $Y_{it}\sim \mathrm{gamma}\left(a,\frac
  {a}{\mathbb{E}(Y_{it})} \right)$, where the shape parameter $a$ can be
reparameterized into the coefficient of variation (CV), $a=\frac{1}{CV^2}$. We
tested CVs of 0.1, 0.6, and 1.2. The underlying linear predictor was
$\bm{X_{s,t}} \bm{\beta}$ set to zero to focus on the spatial process. Therefore,
our simulation model of data $y_{s,t}$ simplifies to

\begin{align}
  \log(\mu_{s,t}) &\sim \mathrm{MVT}\left(\nu, 0, \Sigma_{W(s,t)}\right),\\
  y_{s,t} &\sim \mathrm{gamma} \left( \frac{1}{\mathrm{CV}^2},
  \frac{1}{\mathrm{CV}^2 \cdot \mu_{s,t} } \right).
\end{align}


We attempted to recapture $\nu$ by fitting a model that matched the process
generating the simulated data.
% TODO: cut the rest of this paragraph to supporting information
We placed weakly informative priors on $\sigma$,
$\eta$, and CV of half-$t$(3, 0, 3) (i.e., the positive half of a Student-$t$
distribution with a degrees of freedom 3, centrality parameter 0, and scale
parameter 3). We initially sampled from each model with 500 iterations across
four chains discarding the first half of the iterations as warm-up. If the
samples had not converged after this initial run, we resampled from the model
with 2000 iterations across four chains. We measured convergence as a minimum
effective sample size of $\ge 100$ and a maximum $\hat{R}$ of $\le 1.05$)
across all parameters.

\subsection{Diagnosing the advantage of allowing for extremes}

To evaluate the consequences of assuming spatial processes are generated from an MVN
distribution when heavy tails are present, we generated simulated
data sets from a MVT random field and compared the fit of models assuming a
MVN random field to ones that correctly included the MVT random field. Specifically, we
simulated data from the following model:

\begin{align}
  \mu_{s,t} &\sim \mathrm{MVT}\left(\nu, 0, \Sigma_{W(s,t)}\right),\\
  y_{s,t} &\sim \mathrm{Normal} \left(\mu_{s,t}, \sigma_{\mathrm{obs}} \right),
\end{align}

\noindent with $\sigma = 0.3$, $\eta = 1.2$, and 100 spatial data points drawn uniformly
from locations ranging between 0 and 10. Again, the locations
of the data, and the 15 knots, were held constant through time to enable faster
computations (this is not a general restriction of the model or our package).
We set the degrees of freedom parameter $\nu$ to 2 (very heavy tails) and used a
Gaussian observation model with standard deviation, $\sigma_{\mathrm{obs}}$, of
0.8. We chose a Gaussian observation
model and identity link for simplicity and to demonstrate an alternative
functional form to the previous simulation. We fit our estimation model as
described above and with a half-$t$(3,0,3) prior on $\sigma_{\mathrm{obs}}$.

To evaluate out-of-sample predictive accuracy we withheld
10\% of the data randomly (10 points per year)
from the model fitting and then compared
the MVT and MVN models:
the root mean squared error
between the $\log(\mu^{\mathrm{withheld}}_{s,t})$
posterior medians and the true $\log\left(\mu^{\mathrm{withheld}}_{s,t}\right)$,
the width of the 95\% credible intervals,
and the difference in the leave-one-out information criteria
\citep[LOOIC;][]{vehtari2016},
a Bayesian information criteria that approximates
leave-one-out predictive performance.

\subsection{Mountain pine beetles in the US Pacific Northwest}

To illustrate real-world applications of MVT-distributed
spatiotemporal models,
we fit MVT and Gaussian random field models
to a data set representing
mountain pine beetle outbreaks in the
US Pacific Northwest states of Oregon and Washington \citep{usdaforestservice2017}.
We converted latitude and longitude degrees into UTMs to have a constant
distance relationship throughout the spatial region and divided the UTM values
by $10^5$ to make the range of $\delta_{ij}$ approximately 10 and therefore
place $\eta$ on a reasonable scale.
We rasterized the map into a 500 by 500 grid
and then aggregated this high-resolution grid
into percent cover in a coarser grid reduced by a factor of 25.
This maintained a reasonable resolution
while limiting the data size for rapid model fitting.
We then modelled the
proportion of grid cells affected by outbreaks
(excluding coarser grid cells that do not contain any outbreaks)
in the US states of Oregon and Washington from 1994 to 2014.
Because the maximum proportion affected was far from $1$, we
can fit a model with a log link and lognormal observation distribution
(as opposed to a logit link and a beta observation distribution).
The log of the mean proportion affected at location $s$ and time $t$, $\mu_{s,t}$
is predicted by a year-specific random walk defined by $\beta_t$,
and the spatiotemporal process $\gamma_{s,t}$,
with the spatial process itself modelled as autoregressive:

\begin{align}
  \log(\mu_{s,t}) &= \beta_0 + \beta_t + \gamma_{s,t},\\
  % \gamma_{s,t} &= \phi \left(\gamma_{s,t-1} -
  % \mathbb{E}[\gamma_{t-1}]\right) + W_{s,t},\\ \label{eq:beetle-mu}
  \gamma_{s^{*},t} &= \phi \gamma_{s^{*},t-1} + W_{s^{*},t},\\ \label{eq:beetle-mu}
  W_{s^{*},t} &\sim \mathrm{MVT}\left(\nu, 0, \Sigma_{W(s^{*},t)}\right).
\end{align}

\noindent Furthermore, we model the annual
mean estimates, $\beta_t$, as following a random walk
constrained by a normal distribution with standard deviation $\sigma_{\beta}$,
and the data, $y_{s,t}$, as generated by a lognormal observation model
with scale parameter $\sigma_{\mathrm{obs}}$:

 \begin{align}
 \beta_t &\sim \mathrm{normal}\left( \beta_{t-1}, \sigma_{\beta} \right),\\
  y_{s,t} &\sim \mathrm{lognormal} \left(  \log(\mu_{s,t}), \sigma_{\mathrm{obs}} \right).
 \end{align}

See the Supporting Information for a formal description
of the posterior and joint
probability distributions.
We chose 20 knots to represent the spatial process
% TODO: make sure knots are correct
(increasing the number of knots did not substantially affect the results).
We fit the models with half-$t$(3, 0, 3) priors on all
scale parameters,
a normal(0, 5) prior on $\beta_0$,
% a MVN(0, TODO) prior on $\gamma_{s,t=1}$,
and a normal(0, 0.5)[-1, 1] prior on $\phi$.

We compared the above MVT
model to a Gaussian random field model.
% in which
% $W_{s,t} \sim \mathrm{MVN}\left(\nu, 0, \Sigma_{W(s,t)}\right)$.
To evaluate out-of-sample predictive accuracy we withheld
25 randomly selected data points
per year from the model fitting,
for a total of 400 withheld data points,
or approximately 10\% of the data.
% We then evaluated the root mean squared error
% between the $\log(\mu^{\mathrm{withheld}}_{s,t})$
% posterior medians and $\log\left(y^{\mathrm{withheld}}_{s,t}\right)$,
We then compared the log predictive density for the held-out data,
the width of the 95\% credible intervals
from the MVN and MVT models, and
the leave-one-out-information-criterion (Supporting Information).

\section{Results}

Under most scenarios we were able to recapture true values of $\nu$ with
reasonable accuracy and low bias (Figure~\ref{fig:recapture}a--c). The
number of time steps had the largest effect on detecting low values
of $\nu$. For example, the median absolute proportional error (MAPE) between
$\nu$ and $\hat{\nu}$ (median of the posterior) was only XX with 25 time steps,
minimal observation error (CV = 0.1), and $\nu = 2.5$
(Figure~\ref{fig:recapture}b). However, the MAPE increased by XX\% and XX\% when
the number of time steps was reduced to 15 and 5, respectively
(Figure~\ref{fig:recapture}b). Observation error did not substantially affect
the estimation of $\nu$ until relatively high levels of observation error
(i.e. CV = 1.2; Figure~\ref{fig:recapture}c).

When the true underlying data were generated with spatiotemporal extremes (MVT,
$\nu = 2$), fitting a Gaussian (MVN) random fields without extremes
reduced out-of-sample predictive accuracy and precision
(Figure~\ref{fig:recapture}d--f). The misspecified model tended to overestimate
$\sigma$ (which controls the magnitude of the random field deviations) to
account for effectively fixing $\nu = \infty$ (e.g.\ Figure~\ref{fig:recapture}d). The
out-of-sample RMSE was usually higher for the misspecified MVN model compared to
a correctly specified MVT model (median RMSE = XX; Figure~\ref{fig:recapture}e).
TODO: something summarizing the credible interval widths here? The leave-one-out
information criterion (LOOIC) correctly chose the MVT model in XX\% of the
simulations.

For the pine beetle case study, the MVT random fields model generated more
accurate and precise out-of-sample predictions (Figure~\ref{fig:map-etc}). The
parameter $\nu$ was estimated at a value indicating
heavy tails in the spatiotemporal process (median
$\nu = XX$, 95\% CI = XX--XX, Figure~\ref{fig:map-etc}c). Advantages of the MVT
model over the MVN included smaller log predictive density for held-out data
(Figure~\ref{fig:map-etc}d), smaller values of LOOIC (SE = XX), and narrower
95\% credible intervals (on average the MVT were XX larger). Predictions from
the MVT model demonstrate evolving hotspots of pine beetle infestation in the
US Pacific Northwest, with particularly strong hotspots in 2009--2010
(Figure~\ref{fig:beetle-pred}).

\section{Discussion}

We have introduced a spatial process model that models spatial random fields
through time with a MVT rather than MVN distribution. Through simulation, we
demonstrate that this new model can be accurately fit to data. With short time
series or considerable observation error, this model reverts to the usual MVN
model. Our simulations show that if
the underlying true process contains spatiotemporal extremes, our MVT model has
superior predictive accuracy and precision. Using a case study on mountain pine beetle
outbreaks in the Pacific
Northwest, we show that our MVT model generates more accurate and precise
out-of-sample predictions compared to a MVN model. Because the MVT model
converges to the MVN model and only requires estimating one
additional parameter, we recommend fitting the MVT model even if anomalous
events are not thought to be present \textit{a priori}.

[TODO: Incorporate references] Many ecological, environmental, and anthropogenic
factors could generate spatiotemporal extremes in responses. First, unmodelled
movement or behaviour could generate spatiotemporal
extremes. For example, the shoaling behavior of fish can change with changes to
population density (e.g. cod in Atlantic Canada REF). Another possible
cause could be spatial climate anomalies. For instance, heat waves \ldots
seaweed example? Heat waves can also increase the likelihood of wildfires or
disease outbreaks, which could generate spatial extremes through time. Finally,
human-caused disasters, such as marine oil spills could cause extremes in
spatial patterns through time. In essence, the MVT random fields model allows
for unexpected and unmodelled events to occur and have less influence on
parameter estimates and predictions.

For our case study of pine beetle outbreak coverage, the MVT model provided
better out-of-sample predictive ability and better precision compared to the same model
with a MVN spatial field. We did not link covariates to the mean response, but it is
possible that their inclusion could help explain the spatial anomalies. Importantly,
our model is descriptive rather than dynamic \citep{cressie2011}.
A dynamic model would include mechanisms governing the spatial evolution of the
pine beetle outbreaks, and these mechanisms could generate the extremes we
observe with our descriptive model. Alternatively, incorporating spatiotemporal
extremes into a dynamic model of pine beetle outbreaks might improve its
predictive capacity.

Our associated R package, \textbf{rrfields}, is designed to be familiar for
anyone who has fit GLMs in R, and includes flexibility for many features beyond
those described thus far. For example, \textbf{rrfields} can be used to fit
spatial GLMs for data without a temporal component (Appendix XX). The package
can fit observation models beyond those included in this paper, such as Poisson,
negative binomial, or binomial, and can include numeric or factor covariates.
% In addition to fixed, independent, and random walk temporal processes, the
% package can fit exchangeable time effects constrained by a Gaussian distribution
% (i.e. ``random effects'').
% , and allows for flexibility in how the spatial process evolves (static field,
% fields modelled as AR1, fields modelled as a random walk, and independent
% exchangeable fields).
\textbf{rrfields} includes familiar R utility functions (e.g.\
\texttt{predict()}) and plotting functions for model checking. Finally, the
package includes a simulation function that can simulate data from any model
that the package can fit, and a series of unit tests that simulate and fit all
major model configurations.

There are a number of limitations to the approach we have described. First,
spatial predictive models require the selection of knots; selecting too few may
not allow the spatial field to be characterized accurately, influencing parameter
estimates. The spatial process might not be well described by a
MVT or MVN random field and be better described by some other form
\citep[e.g.][]{conn2015}. While the MVT random fields model is
more robust than the MVN model, better
predictions and inference might be obtained by explicitly modelling the
processes that generated the extremes. Finally, the MVT random
fields model requires a sufficient number of observations and sufficiently low
sampling error to detect spatial extremes (though when extremes can't be detected,
the model converges to the MVN model).

Our MVT spatial model uses a predictive approach to achieve considerable
efficiency over modelling a full covariance matrix describing all
observed data points. However, an important area for future research is to
include sparse matrix algorithms in spatiotemporal models of extreme events. A
recent advance to spatial models with very large datasets has been the
stochastic partial differential equation (SPDE) approximation to Gaussian random
fields proposed by \citet{lindgren2011}. These methods are accessible via the
integrated nested Laplace approximation (INLA) \citep{rue2009}, which allows for
approximate Bayesian sampling of the posterior without MCMC sampling. Use of the
SPDE-INLA approach has increased rapidly in ecology over the last five years
\citep[e.g.][]{illian2013, ono2016}, and is significantly faster than other
approaches, in part because of integration with Template Model Builder through
software such as VAST (REF). Regardless, the MVT random field model introduced
here is already reasonably efficient, accessible to a wide range of ecologists
and environmental scientists through the included R package, and allows us to
improve predictions for ecological processes with extreme spatial anomalies
through time.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% One of the biggest hurdles in identifying support for MVT spatial fields
% (small estimated df parameter) is using spatiotemporal data sets that have
% enough time slices to capture extreme events. [tie into sim results]. The
% ability to detect spatial anomalies in ecological processes may also be
% affected by the number or selection of knots, however our results show that
% spatial extremes can be identified even using a small numbers of knots. Like
% other state-space models, inference about spatial extremes may be corrupted by
% observation error (both the observation model, and magnitude). Our results
% indicate that spatial events can be identified with moderate to high
% observation error (coefficient of variation ~ 1).
%
% As complex spatial models have become more user-friendly, we expect the rapid
% use of spatiotemporal models to be continued. Examples of possible
% applications beyond bark beetles include to models of fisheries (cite Thorson
% ECE paper), applications to climate anomalies
% (http://www.pnas.org/content/106/Supplement\_2/19723.short), or to other
% disturbances - wildfires, oil spills, and disease outbreaks.]
%
% There are a number of features included in the 'rrfields' package that may be
% useful to ecologists, but beyond the scope of this paper. Examples of features
% include the addition of covariates (numeric or factors), models for temporal
% processes (random effects), and flexible models for the evolution of the spatial
% process (a static field shared across time, fields modelled as an AR(1) process,
% or fields modelled as exchangeable). Like GLMs, we have also provided a range of
% commonly encountered discrete and continuous observation models to fit a wide
% range of data types.

\section{Acknowledgements}

Smith, beetle data, Trevor, Jim, Brian, DFO? \ldots

\section{Data Accessibility}
% : To enable readers to locate archived data, authors should list the database and the respective accession numbers or DOIs for all data from the manuscript

All code and data associated with this paper are available at
\url{https://github.com/seananderson/XX} and are archived at
\url{https://zenodo.org/XX}.
The R package \textbf{rrfields} is available at TODO.

\bibliography{spatial-extremes}

\clearpage

\section{Figures}

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.55\textwidth]{../figs/nu-rf-illustration-small.pdf}
    \caption{An illustration of three draws from a MVN random field (top row)
      vs.\ three draws from a MVT random field with heavy tails
      (degrees of freedom, $\nu$, of 2; bottom row). Random seeds are held constant
      between the rows
      to illustrate the effect. Draws represent slices of time with independent spatial
      processes at each time slice. Note the considerably more extreme values in
      the second draw for the MVT spatial process.}
    \label{fig:nu}
  \end{center}
\end{figure}

\clearpage

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.8\textwidth]{../figs/simulation-results.pdf}
    \caption{Simulation testing the MVT random fields model.
      Upper row
      panels illustrate the ability to recapture the
      degree of spatial heavy tailedness.
      Shown are tests with
      (a) various true values of $\nu$ (the MVT degrees of freedom parameter),
      (b) an increasing number of time steps in the data set (with low observation error),
      and (c) an increasing level of observation error.
      The full factorial results are shown in Figure~\ref{fig:recapture-factorial}.
      Individual dots show the median estimates from individual simulation runs.
      % Polygons show the density of the distribution of estimates.
      The colour scale indicates the true degree of heavy tailedness from
      yellow (effectively normal) to red (very heavy tailed).
      % The parameter $\nu$ has a lower limit of $2$ in the model
      % for computational stability.
      Lower row panels illustrate the impact of fitting MVN and MVT models
      when the true underlying data are drawn from MVT random fields.
      (d) Parameter posteriors for an
      example model fit of a mismatched MVN model (orange)
      and a correct MVT model (blue) (black crosses indicate true values).
      (e) Percent greater root mean squared error (RMSE)
      and (f) $\Delta$ LOOIC (leave-one-out information criteria)
      for the mismatched MVN model compared to the correct MVT model.
    }
    \label{fig:recapture}
  \end{center}
\end{figure}

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.8\textwidth]{../figs/beetle-performance.pdf}
    \caption{
      Model fit characteristics of autoregressive random fields
      models fit to mountain pine beetle data from the US Pacific Northwest.
      (a) Map of the region with individual observations for one year shown with
      brown dots.
      (b) Photograph of a pine beetle infested forest in British Columbia, Canada.
      (c) Posterior and prior distributions of the degrees of freedom parameter, $\nu$.
      (d) Log predictive density for held-out data for MVT (blue) and MVN (orange) models.
      (e) The ratio of 95\% credible interval widths between the MVN and MVT models.
    }
    \label{fig:map-etc}
  \end{center}
\end{figure}

\clearpage

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.65\textwidth]{../figs/beetles-mvt-predictions.pdf}
    \caption{Modelled severity of mountain pine beetle outbreaks in Washington and
      Oregon State in the United States from 1999 to 2014.
      Shown are medians of the modelled parameter $\mu_{s,t}$ from Equation \ref{eq:beetle-mu}
      --- a spatiotemporal MVT random fields model.
    }
    \label{fig:beetle-pred}
  \end{center}
\end{figure}

% \end{flushleft}

\end{spacing}

\begin{spacing}{1.2}

\clearpage

\section{Supporting Information}

\subsection{Posterior and joint distributions}
% EW: I deleted a couple lines below that were redundant. But if you prefer, we could 
% write the equation out in terms of the probabiltiy of the gamma terms -- instead of the 
% W{s,t} -- they're the same, so no preference on my end. 
Below we use the notation $[a|b]$ to describe the conditional distribution of
$a$ given $b$. We can write the joint posterior distribution for the parameters
in the model of mountain pine beetle outbreaks as:

\begin{multline}
  [\bm{\mu},
  \bm{\gamma},
  \bm{W},
  \bm{\beta},
  \phi,
  \eta,
  \nu,
  \sigma^2_{\mathrm{obs}},
  \sigma^2_{\beta},
  \sigma^2
  |
  \bm{y}]
  \propto \\
  \prod_{i=1}^{N}
  [y_{s(i),t(i)} | \mu_{s(i),t(i)}, \sigma^2_{\mathrm{obs}}] \\
  \times \prod_{t=1}^{T}[\beta_t | \beta_{t-1}, \sigma^2_{\beta}] \\
  \times \prod_{t=2}^{T}[W_{s^{*},t} | \nu, \sigma^2, \eta] \\
  \times
  \pi[\beta_{t=1}]
  \pi[\phi]
  \pi[W_{s^{*},t=1}]
  \pi[\eta]
  \pi[\nu]
  \pi[\sigma^2_{\mathrm{obs}}]
  \pi[\sigma^2_{\beta}]
  \pi[\sigma^2],
  \\
\end{multline}

\noindent where the coefficients are defined in the main Methods section. Importantly,
we use parameters with the superscript $\gamma_{s^{*},t}$ to describe the random effects at the 
locations of the unobserved knots, and parameters without the asterisk $\gamma_{s,t}$ to describe the 
projected random effects at the locations of observed data (projection equation in main text). The
joint probability is calculated over points in space $s$, and time $t$ and missing observations,
or replicate observations may be present. 

\subsection{Model comparison calculations}

We compared MVN and MVT models via RMSE (root mean squared error), $\Delta$
LOOIC (leave-one-out information criteria), credible interval width,
and log predictive density. Here, we describe these calculations:

We calculated the log predictive density (lpd) as:

\begin{equation}
  \mathrm{lpd} = \sum^{S}_{s=1}{ \sum^{T}_{t=1}{ \log  p(\mu_{s,t} | \widehat{y_{s,t}}, \theta)}},
\end{equation}

\noindent where $\mu_{s,t}$ represents the true (unobserved) response value at
location $s$ and time $t$, $\widehat{y_{s,t}}$ indicates the predicted
response value at location $s$ and time $t$, and $\theta$ represents estimated
parameters. We display the distribution of these quantities across MCMC
samples.

The Bayesian LOO (leave-one-out) estimate of out-of-sample
predictive fit $\mathrm{elpd}_\mathrm{loo}$ is defined as:
\begin{equation}
  \mathrm{elpd}_\mathrm{loo} = \sum^{n}_{i=1}{\log ( p(y_i | y_{-1}) },
\end{equation}

\noindent where

\begin{equation}
  p(y_i | y_{i-1}) = \int p(y_i | \theta) p (\theta | y_{-i}) d \theta ,
\end{equation}

\noindent is the predictive density given the data without the $i$th data
point \citep{vehtari2016}. For computational efficiency, the LOO R package
calculates LOO using an approach called Pareto smoothed importance sampling
\citep{vehtari2016}.

We calculated the root mean squared error (RMSE) as:

\begin{equation}
  \sqrt{ \sum^{T}_{t=1}{ \sum^{S}_{s=1}{ (\mu_{s,t} - \widehat{ \mu_{s,t} })^2 } } }
\end{equation}

\noindent where $\widehat{\mu_{s,t}}$ represents the median of the posterior
of $\mu_{s,t}$.

We calculated the ratio of the credible interval widths as:

TODO

\clearpage

\end{spacing}

\renewcommand{\thefigure}{S\arabic{figure}}
\renewcommand{\thetable}{S\arabic{table}}
\setcounter{figure}{0}
\setcounter{table}{0}

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.7\textwidth]{../figs/pp-illustration.pdf}
    \caption{
      Illustration of the steps to fitting a predictive process model.
      First we observe spatial data, we select knot locations,
      and we calculate the covariance between the knots and the observed data.
      Then we fit the model with the knots and data remaining constant throughout.
      For each MCMC iteration, values are proposed for the
      knots, those values are projected from the knots to the locations of the observed data,
      and the likelihood is evaluated at the locations of the observed data.}
    \label{fig:didactic}
  \end{center}
\end{figure}
% Might be good to just clarify the values being proposed are values of observed data - not spatial locations

\clearpage

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.90\textwidth]{../figs/sim-recapture.pdf}
    \caption{
      Full factorial results from the simulation shown in Fig.~\ref{fig:recapture}.
      Individual dots show the median estimates from individual simulation runs.
      Polygons indicate probability density of the median estimates of
      individual simulation runs.
      The colour scale indicates the true degree of heavy tailedness from
      yellow (effectively normal) to red (very heavy tailed).
    }
    \label{fig:recapture-factorial}
  \end{center}
\end{figure}

\renewcommand\theadfont{\scriptsize}
\renewcommand\theadalign{cl}

\begin{landscape}
  \begin{table}
    \begin{minipage}{\textwidth}
    \caption{
      Comparison of select R packages for spatiotemporal analysis with random fields.
    }
    \label{tab:packages}
    \begin{scriptsize}
      \begin{tabular}{llllL{2cm}lL{2.4cm}lL{2.0cm}llL{2.0cm}}
        \toprule
        Package  & \thead[l]{MVT \\ random \\ fields} & \thead[l]{Formula          \\ interface} & \thead[l]{Multi-                                                 \\ variate} & Estimation              & \thead[l]{Simulation \\ function} & \thead[l]{Observation                                      \\ model} & \thead[l]{Maximum \\ likelihood \\ estimation} & \thead[l]{Covariance \\ functions} & \thead[l]{AR Spatial \\ Fields} & \thead[l]{Dynamic \\ Linear \\ Models} & URL \\
        \midrule
        spTimer  & No             & Yes     & No      & MCMC                        & No         & Gaussian                                                          & No       & Exponential, Gaussian, Matern family, spherical   & Yes                   & No        & \url{https://CRAN.R-project.org/package=spTimer} \\
        spate    & No             & No      & No      & MCMC/SPDE                   & Yes        & Gaussian, skewed Tobit                                            & Yes      & Matern family                                     & No                    & No        & \url{https://CRAN.R-project.org/package=spate} \\
        spBayes  & No             & Yes     & Yes     & MCMC                        & No         & Gaussian, binomial, Poisson                                       & No       & Exponential, Gaussian, Matern family, spherical   & No                    & Yes       & \url{https://CRAN.R-project.org/package=spBayes} \\
        INLA     & No             & Yes     & Yes     & Approximate posterior/SPDE  & Yes        & Many                                                              & Yes      & Exponential, Gaussian, Matern family, many others & Yes                   & Yes       & \url{http://www.r-inla.org/}                                     \\
        VAST     & No             & No      & No      & Maximum likelihood/SPDE     & Yes        & Gaussian, lognormal, gamma, binomial, Poisson, negative binomial  & Yes      & Matern family                                     & Yes                   & No        & \url{https://github.com/James-Thorson/VAST}                      \\
        rrfields & Yes            & Yes     & No      & MCMC/NUTS                   & Yes        & Gaussian, lognormal, gamma, binomial, Poisson, negative binomial  & No       & Exponential, Gaussian, Matern family              & Yes                   & Yes       & \url{https://github.com/seananderson/rrfields}                  \\
        \bottomrule
      \end{tabular}
    \end{scriptsize}
  \end{minipage}
  \end{table}
\end{landscape}

\end{document}
