\documentclass[12pt,english]{article}
\usepackage{geometry}
\geometry{verbose, letterpaper, tmargin = 2.54cm, bmargin = 2.54cm,
  lmargin = 2.54cm, rmargin = 2.54cm}
\geometry{letterpaper}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{setspace}
\usepackage{url}
\usepackage{lineno}
\usepackage{xcolor}
\usepackage{bm}
\renewcommand\linenumberfont{\normalfont\tiny\sffamily\color{gray}}
\modulolinenumbers[2]
\usepackage{booktabs}
\usepackage{bm}
\textheight 22.0cm

\usepackage{pdflscape}
\usepackage{makecell}
\usepackage{array}
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\usepackage{parskip}
% \setlength{\parindent}{0pt}
% \setlength{\parskip}{1\bigskipamount plus \smallskipamount minus \smallskipamount}
\usepackage{ragged2e}
\usepackage[round,sectionbib]{natbib}
\bibpunct{(}{)}{;}{a}{}{;}
\bibliographystyle{ecology3}

\title{
  Black swans in space:
  robust modelling of extreme spatiotemporal processes}
\author{
Sean C. Anderson$^1$ and
Eric J. Ward$^2$
}
\date{}

\begin{document}

\maketitle
\RaggedRight
\hyphenpenalty=500

\begin{spacing}{1.3}
% \begin{spacing}{1.9}
% \begin{flushleft}

\begin{abstract}

Understanding biological responses to environmental perturbations in time and
space is critical for conservation planning. With projected trends in climate
forcing, for example, conservation biology will have to focus not just on mean
changes, but also on variability and extremes. In ecological systems, extremes
can happen in time, such as population crashes, or in space, such as rapid
range contractions. Here, we introduce a statistical model that extends current
methods for joint inference about temporal and spatial dynamics (spatiotemporal
modelling with Gaussian random fields) to allow for and detect extremes that
occur simultaneously in time and space. Specifically, our model is a Bayesian
predictive-process model that uses a multivariate-t distribution to describe
spatial random effects. The model is easily implemented with our flexible new R
package \textbf{rrfields}, which uses an interface that should be familiar to
anyone who has worked with regression in R. We illustrate applications of our
model and R package simulated and real-world data. First, using simulated data,
we demonstrate the ability to recapture spatiotemporal extremes, and explore
the consequences of fitting models that ignore such extremes. Second, apply our
models to predict tree mortality from mountain pine beetle (\emph{Dendroctonus
  ponderosae}) outbreaks in the US Pacific Northwest over the last 16 years.
We show that our model provides more accurate and certain
predictions of these ecological processes compared to traditional
spatiotemporal models that do not allow for extremes. Jointly modelling
ecological processes in time and space represents an important step forward to
creating realistic models of anomalies, and allows us to improve predictions
that feed into conservation decisions. Distributing this tool as an R package
should make these models accessible to a wide range of conservation biologists
and scientists in other disciplines interested in predicting extreme events.
\end{abstract}

\section{Introduction}

% TODO: cite \citep{conn2015}

Applications of statistical models that allow for joint inference about spatial
and temporal dynamics have advanced rapidly in ecology over the last several
decades \citep[e.g.][]{bascompte1995, latimer2009}. Spatiotemporal models have
also been widely used in other disciplines, including applications to weather,
remote sensing, human disease dynamics, and crime \citep{cressie2011}. When
ecological data are spatially structured, explicitly accounting for spatial
autocorrelation improves model predictions and inference about parameters of
interest --- including recommendations used in management or conservation
planning (REF).

Including spatial components in statistical models involves extending models
that most ecologists are already familiar with, such as generalized linear
models (GLMs) or generalized additive models (GAMs). Spatial relationships can
be included as predictors in models of the mean (such as in a 2-dimensional
GAM) or can be included in models of the covariance (e.g.\ kriging). Recent
extensions of these spatial covariance models include modelling spatial
deviations in GLMs or GAMs as multivariate random effects (Gaussian random
fields). Examples of these methods in existing R packages include but are not
limited to \textbf{spBayes} \citep{finley2007}, \textbf{spTimer}
\citep{bakar2015}, \textbf{INLA} \citep{rue2009}, \textbf{RandomFields}
\citep{schlather2016}, and \textbf{spate} \citep{sigrist2015}
(Table~\ref{tab:packages}).

A limitation of spatial models that include Gaussian random fields is that they
may perform poorly when underlying data include anomalous or extreme events.
When these models also include an observation model, for example, anomalous
observations may be reconciled by increasing the variance of the observation
model (rather than attributing these to extremes in the ecological process
being modelled). Extreme events in temporal processes have been modelled using a
variety of methods in ecology, typically by including mixtures of normal and
heavy-tailed distributions \citep[e.g.][]{everitt1996, ward2007, thorson2011}.
More recently, the Student-$t$ distribution has been proposed as a
solution to modelling process variation with extremes in population dynamics
\citep{anderson2017}.

Several robust extensions of Gaussian random fields have been proposed to
better capture extreme spatial events, including applications of max-stable or
extreme value theory \citep{davison2012, davison2012a}. Many of the
applications of these models, such as understanding extremes in rainfall or
flooding, are interested in quantifying the probabilities of exceeding some
threshold \citep{davis2008}. Other extensions of spatiotemporal models to
model extremes include the use of multivariate-$t$ (MVT) spatial random fields
\citep{roislien2007}. Focusing on the latter, to our knowledge these methods
have not been applied in the ecology, fisheries, or environmental sciences.

In this paper we introduce the use of robust spatial predictive models using
the MVT distribution, and provide a user-friendly implementation in our new
R package \textbf{rrfields} (robust random fields). Using simulation testing
to compare the multivariate normal (MVN) to MVT spatial processes, we
illustrate that the MVT leads to better prediction (greater accuracy, more
precision) when the underlying special process is heavy-tailed. We then
illustrate the application of this approach to real-world data that includes
spatial extremes, using data on mountain pine beetle (\textit{Dendroctonus
  ponderosae}) outbreaks in the Pacific Northwest of the United States.

\section{Methods}

We seek to allow for large deviations in an ecological spatial pattern over
time by extending a spatiotemporal predictive process model to use a MVT
distribution instead of the usual Gaussian MVN. Below we describe the form of
our model as implemented in \textbf{rrfields}, describe two simulation tests
exploring model performance, and finally describe the application of our model
to a data set of mountain pine beetle outbreaks.

\subsection{The MVT predictive process model}

\citet{latimer2009} provide an overview of predictive process models for
ecologists. For large datasets that include more than several hundred spatial
locations, estimation of multivariate random effects at the locations of the
data may be computationally prohibitive. One solution to this dimensionality
problem is to estimate the random field as correlated random effects at a
smaller subset of locations or $m$ 'knots' \citep[e.g.][]{latimer2009,
  shelton2014}, where $m < n$, the number of data points. Instead of
estimating an unconstrained $m \times m$ covariance matrix, a covariance
function is specified \emph{a priori} to estimate the covariance between
locations (e.g. exponential, Gaussian, Matern). Given the estimated random
effects at the locations of these knots, and the known distance matrix between
the knots and observed data, the knot random effects can be projected to the
locations of the observations \citep[][Figure~\ref{fig:didactic}]{latimer2009,
  finley2009}.

Here, we summarize the important elements of these models and highlight how
our models differs from the usual MVN version. Our model is essentially a
generalized linear model (GLM) with a spatiotemporal element described by a
MVT random field. The model describes the expected value of the response, $\mu
\equiv \mathbb{E}(y)$, at a set of locations in space $s$ and time $t$ as

\begin{equation}
  g(\mu_{s,t}) = \bm{X}_{s,t} \bm{\beta} + \gamma_{s,t},
\end{equation}

\noindent where $g$ represents a link function (e.g., log, logit, identity),
$\bm{X}_{s,t}$ represents a vector of predictors, and $\bm{\beta}$ represents a
vector of estimated coefficients.
The symbol $\gamma$ represents the spatiotemporal process,
which we describe below.
The variance of the observation component of
our model is a function of the mean via a
probability distribution such as the Gaussian, Poisson, or Gamma.

%A random field is a term used to describe ``random effects'' drawn from a
%multivariate probability distribution representing deviations in a
%two-dimensional space (REF).
Most commonly, spatial random effects are represented as Gaussian random
fields using a MVN distribution with some covariance matrix. Instead, we draw
our values from a MVT. The MVT has one extra parameter compared to the MVN:
the degrees of freedom parameter $\nu$. When $\nu$ is small (say $\nu < 10$)
the distribution has considerably heavier tails than the MVN --- it has a
higher probability of events far from the mean than the MVN
(Fig.~\ref{fig:nu}). As $\nu$ approaches infinity, the distribution approaches
the MVN. For most purposes, the MVT and MVN are indistinguishable for moderate
values of $\nu$ (say $\nu > 20$) similarly to the univariate t-distribution
compared with the univariate normal distribution
\citep[e.g.][]{anderson2017}.

If $W_{s,t}$ defines a random field, then the spatiotemporal element,
$\gamma_{s,t}$, can be made temporally constant (one field shared across time,
$\gamma_{s,t} = W_{s}$), independent at each time step ($\gamma_{s,t} =
W_{s,t}$), or autoregressive so that the spatial pattern at time $t$ is
dependent on the spatial pattern at time $t-1$ to a degree defined by $\phi$,
($\gamma_{s,t} = \phi \gamma_{s,t-1} + W_{s,t}$).
% In the last case,
% we constrain the spatiotemporal autoregressive process to be centred on zero at
% each time step to aid interpretation and ensure identifiability ($\gamma_{s,t}
% = \phi (\gamma_{s,t-1} - \mathbb{E}[\gamma_{t-1}]) + W_{s,t}$). This lets the
% mean process be defined by the linear predictor ($\bm{X_{s,t}}\bm{\beta}$)
% while $\gamma_{s,t}$ defines the spatial process and how it evolves through
% time --- potentially letting ``hotspots'' remain hotspots through time while
% keeping the means of the spatial process $\gamma_{s,t}$ stationary and centred
% on zero.
We determine the location of the $m$ knots in a random field
using the partitioning around
algorithm \citep[the \texttt{pam} function in the R package
\textbf{cluster};][]{reynolds2006}. This algorithm is a robust version of the
common k-means algorithm and results in selecting knot locations that are
proportional to spatial sampling intensity.

We used a squared exponential covariance function to model the covariance
between knot locations. The squared exponential function, $H$, (also known as
the Gaussian covariance function) is one of the most commonly adopted
covariance functions for spatiotemporal models and models the correlation
between points $i$ and $j$ as $H(\delta_{ij}) = \exp
\left(-\frac{\delta_{ij}^2}{2 \eta} \right)$, where $\delta_{ij}$ describes the
distance between points $i$ and $j$ and $\eta$ describes how steeply
correlation declines with increasing distance or the wiggliness of the
spatial process. For a given set of $\delta_{ij}$, large values of $\eta$
correspond to smooth spatial patterns and small values correspondence to wiggly
spatial patterns --- the degree of wiggliness implied by a value of $\eta$
depends on the scale of the $\delta_{ij}$.

The elements of the covariance matrix at the $m$ knot locations are therefore
defined as $\Sigma_{ij}^*=\sigma^2 \left( \frac{-\delta_{ij}^2}{2 \eta} \right)$ with the
parameter $\sigma$ scaling the amplitude of the spatial process deviations. Our
package also allows for the exponential covariance function $H(\delta_{ij}) =
\exp \left(-\frac{\delta_{ij} }{\eta} \right)$ and the Matern family and could be
extended to include anisotropic functions in which covariance is not uniform
in all directions. Following \citet{latimer2009}, we can calculate the
covariance matrix between the locations of the data and the knots,
$\Sigma_{\left(W, W^* \right)}$.
% Each element of the covariance matrix $\Sigma^*$ is thus dependent on
% three quantities: (1) $\delta_{ij}$ the known distance between points $i$ and
% $j$ squared, (2) the scale parameter $\phi$, which determines how steeply the
% correlation declines with increasing distance, and (3) the variance $\sigma^2$.
Given $\Sigma^*$, we can generate random effects at knot
locations by drawing from a MVT distribution for each time step $t$,
$W_t^*\sim \mathrm{MVT}\left( \nu, 0, \Sigma^{*} \right)$.
These random effects at the knots are then projected to the data locations using
$\Sigma_{\left( W,W^{*} \right)}$ \citep{latimer2009}:
$W=\Sigma_{\left(W,W^* \right)}^{'} \Sigma^{*-1}W^*$.

Our package fits these models in a Bayesian framework. We sample
from the posterior distribution using the No-U-Turn Sampler, which is an
extension of Hamiltonian Markov Chain Monte Carlo, implemented in the
statistical software Stan \citep{standevelopmentteam2016a, carpenter2017}
and the R package \textbf{rstan} \citep{standevelopmentteam2016}. Although slower
than an equivalent maximum likelihood approach, this Bayesian approach has a
number of advantages. First, it lets us fully and accurately quantify
uncertainty around all parameter estimates and predictions. This makes it
simple to calculate the probability of specific events happening (e.g., the
probability of abundance falling below some threshold at a given point in space
and time). Given the nature of extreme events, this is likely to be a desired
result from such a model. Second, the Bayesian framework lets us place weakly
informative priors on parameters to impose our existing knowledge of reasonable
values and to aid computation --- particularly of difficult to estimate
parameters such as the degrees of freedom parameter in the MVT. In the case of
the degrees of freedom parameter, $\nu$, we bound the lower value to $2$ for
computational stability and use a Gamma(2, 0.1) prior (i.e., shape = 2, rate = 0.1),
which has a mean of $20$ and a median of $\sim 17$ \citep{juarez2010}.
If the data are not informative about heavy
tails, our estimate of $\nu$ should approximately match the prior.

\subsection{Testing the recovery of extremeness}

We used simulation testing to evaluate how well we could recover the degree to
which there were heavy tails in the spatial process under various conditions.
We simulated 50 data points collected at the same survey locations each year
for 5, 15, or 25 years. We simulated the spatial process as independent each
year ($\gamma_{s,t} = W_{s,t}$) with $\sigma^2 = 1$ (the spatial variance),
$\eta = 1$ (the wiggliness or spatial correlation decay parameter), and
with spatial data locations drawn uniformly from 0 to 10 on both spatial axes
(thereby affecting $\delta_{ij}$, the spatial distances).
We selected 15 knots to represent the spatial pattern as described above.
We set the degrees of freedom parameter $\nu$ to
one of three values: 2.5, 5, or 20, representing very heavy tails, moderately heavy
tails, and effectively normal tails. A final step in our data
simulation was to corrupt the ``true'' data by including measurement or
observation error. We assumed observations were generated from a gamma
distribution with a log link, $Y_{it}\sim \mathrm{Gamma}\left(a,\frac
  {a}{\mathbb{E}(Y_{it})} \right)$, where the gamma shape parameter $a$ can be
reparameterized into the coefficient of variation (CV), $a=\frac{1}{CV^2}$. We
tested CVs of 0.1, 0.6, and 1.2 representing minimal, moderate, and
considerable measurement error. We set the underlying linear predictor
$\bm{X_{s,t}} \bm{\beta}$ to zero to focus on the spatial process. Therefore,
our simulation model of data $y_{s,t}$ simplifies to

\begin{align}
  \log(\mu_{s,t}) &\sim \mathrm{MVT}\left(\nu, 0, \Sigma_{W(s,t)}\right),\\
  y_{s,t} &\sim \mathrm{Gamma} \left( \frac{1}{\mathrm{CV}^2},
  \frac{1}{\mathrm{CV}^2 \cdot \mu_{s,t} } \right).
\end{align}

We attempted to recapture $\nu$ by fitting a model that matched the process
generating the simulated data. We placed weakly informative priors on $\sigma$,
$\eta$, and CV of half-$t$(3, 0, 3) (i.e., the positive half of a Student-$t$
distribution with a degrees of freedom 3, centrality parameter 0, and scale
parameter 3). We initially sampled from each model with 500 iterations across
four chains discarding the first half of the iterations as warm-up. If the
samples had not converged after this initial run, we resampled from the model
with 2000 iterations across four chains. We measured convergence as a minimum
effective sample size of $\ge 100$ and a maximum $\hat{R}$ of $\le 1.05$)
across all parameters.

\subsection{Diagnosing the advantage of allowing for extremes}

To evaluate the consequences of assuming a MVN spatial process when the
true spatial process has heavy tails drawn from a MVT, we generated simulated
data sets from a MVT random field and fit models assuming a
MVN random field or the
correct MVT random field.
We then compared the performance of these models. Specifically, we
simulated data from the following model:

\begin{align}
  \mu_{s,t} &\sim \mathrm{MVT}\left(\nu, 0, \Sigma_{W(s,t)}\right),\\
  y_{s,t} &\sim \mathrm{Normal} \left(\mu_{s,t}, \sigma_{\mathrm{obs}} \right),
\end{align}

\noindent with $\sigma = 0.3$, $\eta = 1.2$, and 100 spatial data points drawn uniformly
from locations ranging between 0 and 10 along both axes. Again, the locations
of the data, and the 15 knots, were held constant through time to enable faster
computations (this is not a general restriction of the model).
We set the degrees of freedom parameter $\nu$ to 2 (very heavy tails) and used a
Gaussian observation model with standard deviation, $\sigma_{\mathrm{obs}}$, of
0.8. We chose a Gaussian observation
model and identity link for simplicity and to demonstrate an alternative
functional form to the previous simulation. We fit our estimation model as
described above and with a half-$t$(3,0,3) prior on $\sigma_{\mathrm{obs}}$.

To evaluate out-of-sample predictive accuracy we withheld
10 randomly selected data points
per year (10\% of the data) from the model fitting.
We then compared between the MVT and MVN models:
the root mean squared error
between the $\log(\mu^{\mathrm{withheld}}_{s,t})$
posterior medians and $\log\left(y^{\mathrm{withheld}}_{s,t}\right)$,
the width of the 95\% credible intervals,
and the difference in the leave-one-out information criteria
\citep[LOOIC;][]{vehtari2016},
a Bayesian information criteria that approximates
leave-one-out predictive performance.

\subsection{Mountain pine beetles in the US Pacific Northwest}

To illustrate real-world applications of MVT-distributed
spatiotemporal models and the \textbf{rrfields} package,
we fit MVT and Gaussian random field models
to a data set representing
mountain pine beetle outbreaks in the
US Pacific Northwest states of Oregon and Washington \citep{usdaforestservice2017}.
We converted latitude and longitude degrees into UTMs to have a constant
distance relationship throughout the spatial region and divided the UTM values
by $10^5$ to make the range of $\delta_{ij}$ approximately 10 and therefore
place $\eta$ on a reasonable scale.
We rasterized the map into a 500 by 500 grid
and then aggregated this high-resolution grid
into percent cover in a coarser grid reduced by a factor of 25.
This maintained a reasonable resolution
while limiting the data size for rapid model fitting.
We then modelled the
proportion of grid cells affected by outbreaks
in the US states of Oregon and Washington from 1994 to 2014.
Because the maximum proportion affected was far from $1$, we
can fit a model with a log link and lognormal observation distribution
(as opposed to a logit link and a beta observation distribution).
The log of the mean proportion affected at location $s$ and time $t$, $\mu_{s,t}$
is predicted by a year-specific random walk defined by $\beta_t$,
and the spatiotemporal process $\gamma_{s,t}$,
with the spatial process itself modelled as autoregressive:

\begin{align}
  \log(\mu_{s,t}) &= \beta_0 + \beta_t + \gamma_{s,t},\\
  % \gamma_{s,t} &= \phi \left(\gamma_{s,t-1} -
  % \mathbb{E}[\gamma_{t-1}]\right) + W_{s,t},\\ \label{eq:beetle-mu}
  \gamma_{s,t} &= \phi \gamma_{s,t-1} + W_{s,t},\\ \label{eq:beetle-mu}
  W_{s,t} &\sim \mathrm{MVT}\left(\nu, 0, \Sigma_{W(s,t)}\right).
\end{align}

\noindent Furthermore, we model the annual
mean estimates, $\beta_t$, as following a random walk
constrained by a normal distribution with standard deviation $\sigma_{\beta}$,
and the data, $y_{s,t}$, as generated by a lognormal observation model
with scale parameter $\sigma_{\mathrm{obs}}$:

 \begin{align}
 \beta_t &\sim \mathrm{Normal}\left( \beta_{t-1}, \sigma_{\beta} \right),\\
  y_{s,t} &\sim \mathrm{LogNormal} \left(  \log(\mu_{s,t}), \sigma_{\mathrm{obs}} \right).
 \end{align}

See the Supporting Information for a definition of the posterior and joint
probability distributions.
We chose 25 knots to represent the spatial process
(increasing the number of knots did not substantially affect the results).
We fit the models with half-$t$(3, 0, 3) priors on all
scale parameters,
a Normal(0, 10) prior on $\beta_0$,
% a MVN(0, TODO) prior on $\gamma_{s,t=1}$,
and a Normal(0, 0.5)[-1, 1] prior on $\phi$.

We compared the above MVT
model to a Gaussian random field model.
% in which
% $W_{s,t} \sim \mathrm{MVN}\left(\nu, 0, \Sigma_{W(s,t)}\right)$.
To evaluate out-of-sample predictive accuracy we withheld
25 randomly selected data points
per year from the model fitting,
for a total of 400 withheld data points,
or approximately 10\% of the data.
% We then evaluated the root mean squared error
% between the $\log(\mu^{\mathrm{withheld}}_{s,t})$
% posterior medians and $\log\left(y^{\mathrm{withheld}}_{s,t}\right)$,
We then compared the log predictive density for the held-out data
% TODO: equation?
and the width of the 95\% credible intervals
from the MVN and MVT models.

A complete reproducible version of this analysis is available at
\url{https://github.com/seananderson/spatiotemporal-extremes} DOI: TODO.

\section{Results}

Under most scenarios we were able to recapture the value of $\nu$ with
reasonable accuracy and without bias (Figure~\ref{fig:recapture}a--c).
The number of time steps had the largest effect on the ability to detect low
values of $\nu$. For example, the median absolute proportional error (MAPE)
between $\nu$ and $\hat{\nu}$ (median of the posterior) was only XX in the case
with 25 time steps, minimal observation error (CV = 0.1), and $\nu = 2.5$.
However, the MAPE increased by XX\% and XX\% when the number of time steps was
reduced to 15 and 5, respectively (Figure~\ref{fig:recapture}b).
Observation error did not substantially affect the estimation of $\nu$ until it
reached considerable levels (i.e. CV = 1.2; Figure~\ref{fig:recapture}c).

When the true underlying data were generated with spatiotemporal extremes (MVT
$\nu = 2$), fitting a Gaussian (MVN) random fields ignoring these extremes
reduced out-of-sample predictive accuracy and precision
(Figure~\ref{fig:recapture}d--f). The model misspecification tended to result
in an overestimate of $\sigma$ (which controls the magnitude of the random
field deviations) to account for effectively fixing $\nu = \infty$
(Figure~\ref{fig:recapture}d). For the chosen set of parameters, the
out-of-sample RMSE was generally higher for the misspecified MVN model compared
to a correctly specified MVT model that estimated $\nu$ (median RMSE = XX;
Figure~\ref{fig:recapture}e). TODO: something summarizing the credible interval
widths here? The leave-one-out information criterion (LOOIC) correctly
identified the MVT model in XX\% of the simulations.

The MVT random fields model generated more accurate and precise out-of-sample
predictions for the mountain pine beetle data set (Figure~\ref{fig:map-etc}).
The degrees of freedom parameter, $\nu$, was estimated at a value that
indicates considerably heavy tails in the autoregressive spatiotemporal process
(median $\nu = XX$, 95\% CI = XX--XX, Figure~\ref{fig:map-etc}c). The log
predictive density (lpd) for held-out data was higher for the MVT model
compared to the MVN (median lpd = XX vs.\ XX, Figure~\ref{fig:map-etc}d).
Finally, the 95\% credible intervals were on average XX times wider for the MVN
model compared to the MVT model (Figure~\ref{fig:map-etc}e). Spatiotemporal
predictions from the MVT model demonstrate evolving hotspots of pine beetle
infestation in the US Pacific Northwest, particularly in the late 2000s
(Figure~\ref{fig:beetle-pred}).

\section{Discussion}

We have introduced to ecology a model that is robust to spatial extremes through
time. Our model substitutes a MVT distribution for the usual MVN distribution
used in Gaussian Markov random field models, and in doing so, allows for
outlying spatial events to occur. Through simulation, we demonstrate that our
model can be accurately fit to data, but reverts to the MVN version for data of
insufficient quantity or with considerable observation error. We show that if
the underlying true process contains spatiotemporal extremes, then fitting a MVN
model reduces predictive accuracy and precision. Using data on mountain pine
beetle outbreaks in the Pacific Northwest, we show that our MVT model generates
more accurate and precise out-of-sample predictions. Because the MVT model
converges to the MVN model if it is not needed and only requires estimating one
additional parameter, we recommend trying to fit the MVT model even if anomalous
events are not thought to be present \textit{a priori}.

Many ecological, environmental, and anthropogenic factors could generate
spatiotemporal extremes in ecological variables such as biomass or abundance.
First, unmodelled movement or behaviour could generate spatiotemporal extremes.
For example, the shoaling behavior of fish can change with changes to population
density (e.g. cod in Atlantic Canada reference). Another possible cause could be
spatial climate anomalies. For instance, heat waves \ldots seaweed example? Heat
waves can also increase the likelihood of wildfires or disease outbreaks, which
could generate spatial extremes through time. Finally, human-caused disasters,
such as marine oil spills could cause extremes in spatial patterns through time.
In essence, the MVT random fields model allows for unexpected and unmodelled
events to occur and have less influence on parameter estimates and predictions.

Our model provided better out-of-sample predictive ability and more precise
estimates of mountain pine beetle outbreak coverage compared to the same model
with a Gaussian Markov random field. Our model is autoregressive in its annual
mean estimate and in the evolution of the spatial pattern through time and does
not include any ecological or environmental covariates. It is possible that
including covariates such as temperature or elevation might render the remaining
spatial random field as MVN. Importantly, our model is a descriptive
spatiotemporal model, rather than dynamic \citep{cressie2011}. A dynamic model
would include mechanisms governing the spatial evolution of the pine beetle
outbreaks, and these mechanisms could generate the spatiotemporal extremes we
observe with our descriptive model. Alternatively, incorporating spatiotemporal
extremes into a dynamic model of pine beetle outbreaks might improve its
predictive capacity.

Our associated R package, \textbf{rrfields}, is designed to be familiar for
anyone who has fit GLMs in R, and includes flexibility for many features beyond
those described thus far. For example, \textbf{rrfields} can be used to fit
spatial GLMs for data without a temporal component (Appendix XX). The package
can fit observation models beyond those included in this paper, such as Poisson
or binomial, and can include numeric or factor covariates. In addition to fixed,
independent, and random walk temporal processes, the package can fit
exchangeable time effects constrained by a Gaussian distribution (i.e. ``random
effects''), and allows for flexibility in how the spatial process evolves
(static field, fields modelled as AR1, fields modelled as a random walk, and
independent exchangeable fields). \textbf{rrfields} includes familiar utility
functions (e.g.\ \texttt{predict()}) and plotting functions for model checking.
Finally, the package includes a simulation function that can simulate data from
any model that the package can fit, and a series of unit tests that simulate and
fit all major model configurations.

To be sure, there are a number of limitations to the approach we have described.
Our approach shares many of its limitations with most other spatiotemporal
modelling approaches that involve dimension reduction. Most prominently, the
modeller must choose an appropriate number of knots. However, as long as a
sufficient number of knots are chosen, coefficient estimates and projections
should converge on the same answer and multiple versions of a model can be fit
to check this assumption. Fundamentally, the spatial process might not be well
described by a MVT or MVN random field and be better described by some other
form \citep[e.g.][]{conn2015}. Additionally, whereas the MVT random fields model
is more robust than the MVN version in the face of spatiotemporal extremes,
better predictions and inference might be obtained by explicitly modelling the
processes that rendered the spatial effects extreme. Finally, the MVT random
fields model requires a sufficient number of observations and sufficiently low
sampling error to detect extremeness (a low degrees of freedom parameter).
However, when extremeness is present but cannot be detected, the MVT model
reverts to the MVN random fields model and little is lost except estimating one
additional parameter.

Our model uses a predictive process approach to achieve considerable
computational efficiency over modelling a full covariance matrix describing all
observed data points. However, an important area for future research is to
include sparse matrix algorithms in spatiotemporal models of extreme events.
Recent advances to spatial models with very large datasets has been the
stochastic partial differential equation (SPDE) approximation to Gaussian random
fields proposed by \citet{lindgren2011}. These methods have been accessible via
the integrated nested Laplace approximation (INLA) \citep{rue2009}, which allows
for approximate Bayesian sampling of the posterior without MCMC sampling. Use of
the SPDE-INLA approach has increased rapidly in ecology over the last five years
\citep[e.g.][]{illian2013, ono2016}, and is significantly faster than other
approaches (in part, because of integration with TMB, cite VAST etc.).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% One of the biggest hurdles in identifying support for MVT spatial fields
% (small estimated df parameter) is using spatiotemporal data sets that have
% enough time slices to capture extreme events. [tie into sim results]. The
% ability to detect spatial anomalies in ecological processes may also be
% affected by the number or selection of knots, however our results show that
% spatial extremes can be identified even using a small numbers of knots. Like
% other state-space models, inference about spatial extremes may be corrupted by
% observation error (both the observation model, and magnitude). Our results
% indicate that spatial events can be identified with moderate to high
% observation error (coefficient of variation ~ 1).
%
% As complex spatial models have become more user-friendly, we expect the rapid
% use of spatiotemporal models to be continued. Examples of possible
% applications beyond bark beetles include to models of fisheries (cite Thorson
% ECE paper), applications to climate anomalies
% (http://www.pnas.org/content/106/Supplement\_2/19723.short), or to other
% disturbances - wildfires, oil spills, and disease outbreaks.]
%
% There are a number of features included in the 'rrfields' package that may be
% useful to ecologists, but beyond the scope of this paper. Examples of features
% include the addition of covariates (numeric or factors), models for temporal
% processes (random effects), and flexible models for the evolution of the spatial
% process (a static field shared across time, fields modelled as an AR(1) process,
% or fields modelled as exchangeable). Like GLMs, we have also provided a range of
% commonly encountered discrete and continuous observation models to fit a wide
% range of data types.

\section{Acknowledgements}

Smith, DFO?, beetle data, Trevor, Jim, Brian, \ldots

\section{Data Accessibility}
% : To enable readers to locate archived data, authors should list the database and the respective accession numbers or DOIs for all data from the manuscript

All code and data associated with this paper are available at
\url{https://github.com/seananderson/XX} and are archived at
\url{https://zenodo.org/XX}.
The R package \textbf{rrfields} is available at TODO.

\bibliography{spatial-extremes}

\clearpage

\section{Figures}

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.55\textwidth]{../figs/nu-rf-illustration-small.pdf}
    \caption{An illustration of three draws from a MVN random field (top row)
      vs.\ three draws from a MVT random field with heavy tails
      (degrees of freedom, $\nu$, of 2; bottom row). Random seeds are held constant
      between the rows
      to illustrate the effect. Draws represent slices of time with independent spatial
      processes at each time slice. Note the considerably more extreme values in
      the second draw for the MVT spatial process.}
    \label{fig:nu}
  \end{center}
\end{figure}

\clearpage

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.8\textwidth]{../figs/simulation-results.pdf}
    \caption{Simulation testing the MVT random fields model.
      Upper row
      panels illustrate the ability to recapture the
      degree of spatial heavy tailedness.
      Shown are tests with
      (a) various true values of $\nu$ (the MVT degrees of freedom parameter),
      (b) an increasing number of time steps in the data set (with low observation error),
      and (c) an increasing level of observation error.
      The full factorial results are shown in Figure~\ref{fig:recapture-factorial}.
      Individual dots show the median estimates from individual simulation runs.
      % Polygons show the density of the distribution of estimates.
      The colour scale indicates the true degree of heavy tailedness from
      yellow (effectively normal) to red (very heavy tailed).
      % The parameter $\nu$ has a lower limit of $2$ in the model
      % for computational stability.
      Lower row panels illustrate the impact of fitting MVN and MVT models
      when the true underlying data are drawn from MVT random fields.
      (d) Parameter posteriors for an
      example model fit of a mismatched MVN model (orange)
      and a correct MVT model (blue) (black crosses indicate true values).
      (e) Percent greater root mean squared error (RMSE)
      and (f) $\Delta$ LOOIC (leave-one-out information criteria)
      for the mismatched MVN model compared to the correct MVT model.
    }
    \label{fig:recapture}
  \end{center}
\end{figure}

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.8\textwidth]{../figs/beetle-performance.pdf}
    \caption{
      Model fit characteristics of autoregressive random fields
      models fit to mountain pine beetle data from the US Pacific Northwest.
      (a) Map of the region with individual observations for one year shown with
      brown dots.
      (b) Photograph of a pine beetle infested forest in British Columbia, Canada.
      (c) Posterior and prior distributions of the degrees of freedom parameter, $\nu$.
      (d) Log predictive density for held-out data for MVT (blue) and MVN (orange) models.
      (e) The ratio of 95\% credible interval widths between the MVN and MVT models.
    }
    \label{fig:map-etc}
  \end{center}
\end{figure}

\clearpage

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.65\textwidth]{../figs/beetles-mvt-predictions.pdf}
    \caption{Modelled severity of mountain pine beetle outbreaks in Washington and
      Oregon State in the United States from 1999 to 2014.
      Shown are medians of the modelled parameter $\mu_{s,t}$ from Equation \ref{eq:beetle-mu}
      --- a spatiotemporal MVT random fields model.
    }
    \label{fig:beetle-pred}
  \end{center}
\end{figure}

% \end{flushleft}

\end{spacing}

\clearpage

\section{Supporting Information}

\subsection{Posterior and joint distributions}

The beetle model:

\begin{multline}
  [\bm{\mu},
  \bm{\gamma},
  \bm{W},
  \bm{\beta},
  \phi,
  \eta,
  \nu,
  \sigma^2_{\mathrm{obs}},
  \sigma^2_{\beta},
  \sigma^2
  |
  \bm{y}]
  \propto \\
  \prod_{s=1}^{S} \prod_{t=1}^{T}
  [y_{s,t} | \mu_{s,t}, \sigma^2_{\mathrm{obs}}] \\
  \times [\mu_{s,t} | \mu_{s,t-1}, \beta_t, \gamma_{s,t} ] \\
  \times [\gamma_{s,t} | \gamma_{s,t-1}, \phi, W_{s,t}] \\
  \times [\beta_t | \beta_{t-1}, \sigma^2_{\beta}] \\
  \times [W_{s,t} | \nu, \sigma^2, \eta] \\
  \times
  [\beta_{t=1}]
  [\phi]
  [\gamma_{s,t=1}]
  [\eta]
  [\nu]
  [\sigma^2_{\mathrm{obs}}]
  [\sigma^2_{\beta}]
  [\sigma^2].
  \\
\end{multline}

\subsection{Model comparison calculations}

We compared MVN and MVT models via RMSE (root mean squared error), $\Delta$
LOOIC (leave-one-out information criteria), credible interval width,
and log predictive density. Here, we describe these calculations:

We calculated the log predictive density (lpd) as:

\begin{equation}
  \mathrm{lpd} = \sum^{S}_{s=1}{ \sum^{T}_{t=1}{ \log  p(\mu_{s,t} | \widehat{y_{s,t}}, \theta)}},
\end{equation}

\noindent where $\mu_{s,t}$ represents the true (unobserved) response value at
location $s$ and time $t$, $\widehat{y_{s,t}}$ indicates the predicted
response value at location $s$ and time $t$, and $\theta$ represents estimated
parameters. We display the distribution of these quantities across MCMC
samples.

The Bayesian LOO (leave-one-out) estimate of out-of-sample
predictive fit $\mathrm{elpd}_\mathrm{loo}$ is defined as:
\begin{equation}
  \mathrm{elpd}_\mathrm{loo} = \sum^{n}_{i=1}{\log ( p(y_i | y_{-1}) },
\end{equation}

\noindent where

\begin{equation}
  p(y_i | y_{i-1}) = \int p(y_i | \theta) p (\theta | y_{-i}) d \theta ,
\end{equation}

\noindent is the predictive density given the data without the $i$th data
point \citep{vehtari2016}. For computational efficiency, the LOO R package
calculates LOO using an approach called Pareto smoothed importance sampling
\citep{vehtari2016}.

We calculated the root mean squared error (RMSE) as:

\begin{equation}
  \sqrt{ \sum^{T}_{t=1}{ \sum^{S}_{s=1}{ (\mu_{s,t} - \widehat{ \mu_{s,t} })^2 } } }
\end{equation}

\noindent where $\widehat{\mu_{s,t}}$ represents the median of the posterior
of $\mu_{s,t}$.

We calculated the ratio of the credible interval widths as:

TODO

\renewcommand{\thefigure}{S\arabic{figure}}
\renewcommand{\thetable}{S\arabic{table}}
\setcounter{figure}{0}
\setcounter{table}{0}

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.7\textwidth]{../figs/pp-illustration.pdf}
    \caption{
      Illustration of the steps to fitting a predictive process model.
      First we observe spatial data, we select knot locations,
      and we calculate the covariance between the knots and the observed data.
      Then we fit the model with the knots and data remaining constant throughout.
      For each MCMC iteration, values are proposed for the
      knots, those values are projected from the knots to the locations of the observed data,
      and the likelihood is evaluated at the locations of the observed data.}
    \label{fig:didactic}
  \end{center}
\end{figure}
% Might be good to just clarify the values being proposed are values of observed data - not spatial locations

\clearpage

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.90\textwidth]{../figs/sim-recapture.pdf}
    \caption{
      Full factorial results from the simulation shown in Fig.~\ref{fig:recapture}.
    }
    \label{fig:recapture-factorial}
  \end{center}
\end{figure}

\renewcommand\theadfont{\scriptsize}
\renewcommand\theadalign{cl}

\begin{landscape}
  \begin{table}
    \begin{minipage}{\textwidth}
    \caption{
      Comparison of select R packages for spatiotemporal analysis with random fields.
    }
    \label{tab:packages}
    \begin{scriptsize}
      \begin{tabular}{llllL{2cm}lL{2.4cm}lL{2.0cm}llL{2.0cm}}
        \toprule
        Package  & \thead[l]{MVT \\ random \\ fields} & \thead[l]{Formula          \\ interface} & \thead[l]{Multi-                                                 \\ variate} & Estimation              & \thead[l]{Simulation \\ function} & \thead[l]{Observation                                      \\ model} & \thead[l]{Maximum \\ likelihood \\ estimation} & \thead[l]{Covariance \\ functions} & \thead[l]{AR Spatial \\ Fields} & \thead[l]{Dynamic \\ Linear \\ Models} & URL \\
        \midrule
        spTimer  & No             & Yes     & No      & MCMC                        & No         & Gaussian                                                          & No       & Exponential, Gaussian, Matern family, Spherical   & Yes                   & No        & \url{https://CRAN.R-project.org/package=spTimer} \\
        spate    & No             & No      & No      & MCMC/SPDE                   & Yes        & Gaussian, skewed Tobit                                            & Yes      & Matern family                                     & No                    & No        & \url{https://CRAN.R-project.org/package=spate} \\
        spBayes  & No             & Yes     & Yes     & MCMC                        & No         & Gaussian, Binomial, Poisson                                       & No       & Exponential, Gaussian, Matern family, Spherical   & No                    & Yes       & \url{https://CRAN.R-project.org/package=spBayes} \\
        INLA     & No             & Yes     & Yes     & Approximate posterior/SPDE  & Yes        & Many                                                              & Yes      & Exponential, Gaussian, Matern family, many others & Yes                   & Yes       & \url{http://www.r-inla.org/}                                     \\
        VAST     & No             & No      & No      & Maximum likelihood/SPDE     & Yes        & Gaussian, Lognormal, Gamma, Binomial, Poisson, Negative Binomial  & Yes      & Matern family                                     & Yes                   & No        & \url{https://github.com/James-Thorson/VAST}                      \\
        rrfields & Yes            & Yes     & No      & MCMC/NUTS                   & Yes        & Gaussian, Lognormal, Gamma, Binomial, Poisson, Negative Binomial  & No       & Exponential, Gaussian, Matern family              & Yes                   & Yes       & \url{https://github.com/seananderson/rrfields}                  \\
        \bottomrule
      \end{tabular}
    \end{scriptsize}
  \end{minipage}
  \end{table}
\end{landscape}

\end{document}
