# Test a non-centered version of the multivariate t

The center diversions of our models sometimes end up with divergences, which makes it hard to trust our results. Most likely, switching to a non-centered version should fix that. But we have to make sure that the parameterization is correct. This script will test to make sure that we get the same output with a simulated data set between the centered and non-centered versions with the multivariate t. This requires working with the gamma mixture version of the t, which in itself may help with the divergences. 

```{r}
library(tidyverse)
source("simulationTesting/sim_mvt_rf.R")
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = 4L)
```

The observation model should be irrelevant so I will work with the gamma parameterization which is already set up to work in this simulation. 

```{r}
sim_fit <- function(df = 4, n_draws = 15, n_knots = 15, gp_scale = 0.25, 
  cv_obs = 0.1, comment = "", sigma_t = 0.5, nDataPoints = 100) {

  g <- data.frame(lon = runif(nDataPoints, 0, 10),
    lat = runif(nDataPoints, 0, 10))
  n_pts <- nrow(g)

  simulation_data <- sim_mvt_rf(df = df, grid = g, n_pts = n_pts, seed = NULL,
    n_draws = n_draws, n_knots = n_knots, gp_scale = gp_scale, sigma_t = sigma_t)
  
  # plot:
  out <- reshape2::melt(d$proj)
  names(out) <- c("i", "pt", "re")
  out <- arrange(out, i, pt)
  out$lon <- rep(g$lon, draws)
  out$lat <- rep(g$lat, draws)
  p1 <- out %>%
    ggplot(aes(x = lon, y = lat, z = re, colour = re)) +
    facet_wrap(~i, ncol = 5) +
    geom_point(size = 3) +
    viridis::scale_color_viridis() +
    theme_light()
  p1

  gamma.a <- 1/(cv_obs^2)
  gamma.b <- gamma.a/exp(simulation_data$proj)
  y.gamma <- rgamma(nrow(gamma.b)*ncol(gamma.b), shape = gamma.a, rate = c(gamma.b))
  y <- matrix(y.gamma, ncol = ncol(gamma.b))
  model_data <- list(nKnots = nrow(simulation_data$knots), nLocs = n_pts,
    nT = nrow(simulation_data$re_knots), y = y,
    distKnotsSq = simulation_data$dist_knots_sq,
    distKnots21Sq = simulation_data$dist_knots21_sq)
  list(model_data = model_data, plot = p1)
}

set.seed(123)
out <- sim_fit()
d <- out$model_data
print(out$plot)
pars <- c("scaledf", "gp_scale", "gp_sigmaSq", "CV", "spatialEffectsKnots")
```


```{r}
m_mvt <- stan("stan_models/mvtGamma_estSigma.stan", 
  data = d, chains = 4L, warmup = 300L, iter = 600L, pars = pars)
b_mvt <- broom::tidyMCMC(m_mvt, rhat = TRUE, ess = TRUE,
   pars = pars[-5])
```

```{r}
m_mvt_mixture <- stan("stan_models/mvtGamma_estSigma_mixture.stan", 
  data = d, chains = 4L, warmup = 300L, iter = 600L, pars = pars)
b_mvt_mixture <- broom::tidyMCMC(m_mvt_mixture, rhat = TRUE, ess = TRUE, 
  pars = pars[-5])
```

```{r}
m_mvt_mixture_nc <- stan("stan_models/mvtGamma_estSigma_mixture_nc.stan", 
  data = d, chains = 4L, warmup = 300L, iter = 600L, pars = pars)
b_mvt_mixture_nc <- broom::tidyMCMC(m_mvt_mixture_nc, rhat = TRUE, ess = TRUE,
   pars = pars[-5])
```
