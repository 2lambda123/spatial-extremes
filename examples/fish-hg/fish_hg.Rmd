---
output:
  pdf_document: default
  html_document: default
---

# Example of Fish toxicity (Hg concentrations)

Data taken from EMMMA, https://emmma.usgs.gov/datasets.aspx. Samples from Wisconsin used 1985-1994. Different spp accumulate samples slightly differently, so we modeled Hg concentration for a single species (Black Crappie). We restricted the analysis to (1) samples that contained single fish sampled, and (2) sites with 3 or more samples collected. 10% of the data was randomly sampled for a holdout / test data set. The df parameter is estimated to be small (~ 4). Predictions for the 2 models for the test dataset show (1) lower RMSE and lower MAPE for the MVT model, and (2) narrower predictive intervals

```{r packages, echo=TRUE, silent=TRUE, message=FALSE, warning=FALSE, results='hide'}
library(sp)
library(rgdal)
library(ggplot2)
library(rrfields)
library(rstan)
library(dplyr)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

## Load data

```{r load}
load("../../examples/fish-hg/fish_hg_models.Rdata")
runModels = FALSE

if(runModels==TRUE) {
  
d = read.csv("examples/fish-hg/National_Fish2_WI.csv")
d = d[which(d$CommonName=="Black Crappie" & d$NumFish == 1 & 
    d$SampleType == "SKIN ON FILLET "),]

d$lon = d$LongDD
d$lat = d$LatDD

d = filter(d, Year %in% seq(1985, 1994)) %>%
  filter(lat != -999 & lon != -999) 
d = group_by(d, StationID) %>% 
  mutate(n = n()) %>% 
  filter(n >= 3) %>% ungroup
d$StationID = as.numeric(as.factor(d$StationID))

d$ID = seq(1,nrow(d))
coordinates(d) = c("lon","lat")
proj4string(d) <- CRS("+proj=longlat +datum=WGS84")  ## for example
d = as.data.frame(spTransform(d, CRS(paste("+proj=utm +zone=11"," ellps=WGS84",sep=''))))
d$lat = d$lat/1000000
d$lon = d$lon/1000000
d$Year = d$Year - min(d$Year) + 1

library(ggplot2)
ggplot(d, aes(lon, lat, colour = HgResult)) + geom_point() +
  facet_wrap(~Year)

ggplot(d, aes(lon, lat, colour = Length)) + geom_point() +
  facet_wrap(~Year)

set.seed(1)
holdout = sample(1:nrow(d), size=round(nrow(d)*0.1,0), replace=F)
mvt_gamma = rrfield(HgResult ~ Length, 
  data = d[-holdout,], 
  time = "Year", lon = "lon", lat = "lat", station = "StationID", 
  nknots = 15, 
  obs_error = "gamma", 
  prior_gp_sigma = half_t(3, 0, 2),
  prior_gp_scale = half_t(3, 0, 2),
  prior_intercept = student_t(100, 0, 10),
  prior_beta = student_t(100, 0, 1), 
  prior_sigma = half_t(3, 0, 2),
  estimate_df = TRUE, 
  chains = 4, iter = 1000,
  control = list(adapt_delta = 0.99))

mvn_gamma = rrfield(HgResult ~ Length, 
  data = d[-holdout,], 
  time = "Year", lon = "lon", lat = "lat", station = "StationID", 
  nknots = 15, 
  obs_error = "gamma", 
  prior_gp_sigma = half_t(3, 0, 2),
  prior_gp_scale = half_t(3, 0, 2),
  prior_intercept = student_t(100, 0, 10),
  prior_beta = student_t(100, 0, 1), 
  prior_sigma = half_t(3, 0, 2),
  estimate_df = FALSE, 
  chains = 4, iter = 1000,
  control = list(adapt_delta = 0.99))
}
```

## Calculate prediction intervals

```{r intervals}
# Plot the predictions from each object to the fitted data
mvt_pred_train = predict(mvt_gamma, mcmc_draws = 1000,
  conf_level = 0.95, interval = "confidence")
mvn_pred_train = predict(mvn_gamma, mcmc_draws = 1000,
  conf_level = 0.95, interval = "confidence")

#plot(log(mvt_pred_train$estimate), log(d$HgResult[-holdout]),col="red", 
# xlim=c(-10,10), ylim=range(log(d$HgResult[-holdout])))
#points(log(mvn_pred_train$estimate), log(d$HgResult[-holdout]),col="blue")

mvt_pred = predict(mvt_gamma, newdata = d[holdout,], mcmc_draws = 1000,
  conf_level = 0.95, interval = "prediction")
mvn_pred = predict(mvn_gamma, newdata = d[holdout,], mcmc_draws = 1000,
  conf_level = 0.95, interval = "prediction")

mvt_rmse = sqrt(mean((mvt_pred$estimate - d[holdout,"HgResult"])^2))
mvn_rmse = sqrt(mean((mvn_pred$estimate - d[holdout,"HgResult"])^2))
mvt_mape = mean(abs((d[holdout,"HgResult"] - mvt_pred$estimate) / d[holdout,"HgResult"]))
mvn_mape = mean(abs((d[holdout,"HgResult"] - mvn_pred$estimate) / d[holdout,"HgResult"]))

```

```{r}
#plot of data
#ggplot(d, aes(lon, lat,color=log(HgResult))) + 
# geom_point(alpha=1,size=1) + facet_wrap(~Year)

newdata = expand.grid("lon"=seq(2.4,2.8,length.out = 25),
  "lat"=seq(5.2,5.5,length.out = 25), "Length"=10, "Year"=1:10,"HgResult"=1)
mvt_pred_new = predict(mvt_gamma, newdata = newdata, mcmc_draws = 1000,
  conf_level = 0.95, interval = "confidence")
newdata$estimate = mvt_pred_new$estimate

ggplot(newdata, aes(lon,lat,color=estimate)) + geom_point() + 
  facet_wrap(~Year) + xlab("Lon") + 
  xlab("Lat") + ggtitle("Estimates for 10cm fish")
```



```{r, echo=FALSE, fig.pos="placeHere", fig.cap = "Estimated posterior degrees of freedom for the multivariate-t distribution"}
df=data.frame("x"=extract(mvt_gamma$model)[["df"]])
ggplot(data=df, aes(x=x)) + geom_histogram(alpha=0.5) + xlab("MVT degrees of freedom")
```


```{r, echo=FALSE, fig.pos="placeHere", fig.cap = "Estimated predicted vs observed (blue = mvt)"}
ylims = c(min(c(log(mvt_pred$estimate), log(mvn_pred$estimate))), max(c(log(mvt_pred$estimate), log(mvn_pred$estimate))))
plot(log(d[holdout,"HgResult"]), log(mvn_pred$estimate), col="red",
  pch = 16, cex=0.6, xlab = "Observed", ylab = "Prediction", ylim=ylims, asp = 1)
points(log(d[holdout,"HgResult"]), log(mvt_pred$estimate), cex=0.8, col="blue")
abline(0,1)
```

```{r, echo=FALSE, fig.pos="placeHere", fig.cap = "Ratio of MVN CI widths : MVT CI widtsh"}
ratio = log((mvn_pred$conf_high - mvn_pred$conf_low) / (mvt_pred$conf_high - mvt_pred$conf_low))
hist(ratio, 40, col="grey", xlab = paste0("MVN CI widths : MVT CI widths"), main="")
```


